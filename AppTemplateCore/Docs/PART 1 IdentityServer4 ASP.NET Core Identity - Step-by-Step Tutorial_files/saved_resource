<!DOCTYPE html>
<html lang="en-US">
   <head>
	   <!-- Global site tag (gtag.js) - Google Analytics -->
	   <script async src="https://www.googletagmanager.com/gtag/js?id=UA-149497714-1"></script>
	   <script>
		   window.dataLayer = window.dataLayer || [];
		   function gtag(){dataLayer.push(arguments);}
		   gtag('js', new Date());

		   gtag('config', 'UA-149497714-1');
	   </script>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <link href=" https://deblokt.com/wp-content/uploads/2019/10/favicon.png" rel="icon">
            <link rel="pingback" href="https://deblokt.com/xmlrpc.php" />
      
      <link media="all" href="https://deblokt.com/wp-content/cache/autoptimize/css/autoptimize_d7caf104d5a6b74a33dd091b26246289.css" rel="stylesheet" /><title>PART 1 IdentityServer4 ASP.NET Core Identity - Step-by-Step Tutorial</title>

<!-- This site is optimized with the Yoast SEO plugin v13.4.1 - https://yoast.com/wordpress/plugins/seo/ -->
<meta name="description" content="The official explanation from Microsoft docs is: ASP.NET Core Identity is a membership system that adds login functionality to ASP.NET Core apps."/>
<meta name="robots" content="max-snippet:-1, max-image-preview:large, max-video-preview:-1"/>
<link rel="canonical" href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="PART 1 IdentityServer4 ASP.NET Core Identity - Step-by-Step Tutorial" />
<meta property="og:description" content="The official explanation from Microsoft docs is: ASP.NET Core Identity is a membership system that adds login functionality to ASP.NET Core apps." />
<meta property="og:url" content="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/" />
<meta property="og:site_name" content="Deblokt" />
<meta property="article:section" content="Tutorials" />
<meta property="article:published_time" content="2019-09-23T13:27:59+00:00" />
<meta property="article:modified_time" content="2019-11-07T18:30:05+00:00" />
<meta property="og:updated_time" content="2019-11-07T18:30:05+00:00" />
<meta property="og:image" content="https://deblokt.com/wp-content/uploads/2019/09/PostLogo.jpg" />
<meta property="og:image:secure_url" content="https://deblokt.com/wp-content/uploads/2019/09/PostLogo.jpg" />
<meta property="og:image:width" content="1280" />
<meta property="og:image:height" content="720" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="The official explanation from Microsoft docs is: ASP.NET Core Identity is a membership system that adds login functionality to ASP.NET Core apps." />
<meta name="twitter:title" content="PART 1 IdentityServer4 ASP.NET Core Identity - Step-by-Step Tutorial" />
<meta name="twitter:image" content="https://deblokt.com/wp-content/uploads/2019/09/PostLogo.jpg" />
<script type='application/ld+json' class='yoast-schema-graph yoast-schema-graph--main'>{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://deblokt.com/#website","url":"https://deblokt.com/","name":"Deblokt","inLanguage":"en-US","description":"We inspire people to integrate standard open-source SSO solutions","potentialAction":[{"@type":"SearchAction","target":"https://deblokt.com/?s={search_term_string}","query-input":"required name=search_term_string"}]},{"@type":"ImageObject","@id":"https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#primaryimage","inLanguage":"en-US","url":"https://deblokt.com/wp-content/uploads/2019/09/PostLogo.jpg","width":1280,"height":720},{"@type":"WebPage","@id":"https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#webpage","url":"https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/","name":"PART 1 IdentityServer4 ASP.NET Core Identity - Step-by-Step Tutorial","isPartOf":{"@id":"https://deblokt.com/#website"},"inLanguage":"en-US","primaryImageOfPage":{"@id":"https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#primaryimage"},"datePublished":"2019-09-23T13:27:59+00:00","dateModified":"2019-11-07T18:30:05+00:00","author":{"@id":"https://deblokt.com/#/schema/person/ae34489e91454a8ba6f088ce7d1910af"},"description":"The official explanation from Microsoft docs is: ASP.NET Core Identity is a membership system that adds login functionality to ASP.NET Core apps.","potentialAction":[{"@type":"ReadAction","target":["https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/"]}]},{"@type":["Person"],"@id":"https://deblokt.com/#/schema/person/ae34489e91454a8ba6f088ce7d1910af","name":"deblokt","image":{"@type":"ImageObject","@id":"https://deblokt.com/#authorlogo","inLanguage":"en-US","url":"https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=96&d=mm&r=g","caption":"deblokt"},"sameAs":[]}]}</script>
<!-- / Yoast SEO plugin. -->

<link rel='dns-prefetch' href='//maps.googleapis.com' />
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Deblokt &raquo; Feed" href="https://deblokt.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Deblokt &raquo; Comments Feed" href="https://deblokt.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Deblokt &raquo; 04. PART 1 IdentityServer4 ASP.NET Core Identity Comments Feed" href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/deblokt.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.4"}};
			/*! This file is auto-generated */
			!function(e,a,t){var r,n,o,i,p=a.createElement("canvas"),s=p.getContext&&p.getContext("2d");function c(e,t){var a=String.fromCharCode;s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,e),0,0);var r=p.toDataURL();return s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,t),0,0),r===p.toDataURL()}function l(e){if(!s||!s.fillText)return!1;switch(s.textBaseline="top",s.font="600 32px Arial",e){case"flag":return!c([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])&&(!c([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!c([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]));case"emoji":return!c([55357,56424,55356,57342,8205,55358,56605,8205,55357,56424,55356,57340],[55357,56424,55356,57342,8203,55358,56605,8203,55357,56424,55356,57340])}return!1}function d(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(i=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},o=0;o<i.length;o++)t.supports[i[o]]=l(i[o]),t.supports.everything=t.supports.everything&&t.supports[i[o]],"flag"!==i[o]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[i[o]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(r=t.source||{}).concatemoji?d(r.concatemoji):r.wpemoji&&r.twemoji&&(d(r.twemoji),d(r.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		
	











<link rel='stylesheet' id='themetek-dynamic-colors-css'  href='https://deblokt.com/wp-content/themes/keysoft/themetek/colors-keysoft.css.php?ver=5.4' type='text/css' media='all' />
<link rel='stylesheet' id='redux-google-fonts-css'  href='https://fonts.googleapis.com/css?family=PT+Sans%3A400%2C700%2C400italic%2C700italic%7CWork+Sans%3A100%2C200%2C300%2C400%2C500%2C600%2C700%2C800%2C900&#038;ver=1578998260' type='text/css' media='all' />
<script type='text/javascript' src='https://deblokt.com/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp'></script>

<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/deblokt.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>







<link rel='https://api.w.org/' href='https://deblokt.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://deblokt.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://deblokt.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4" />
<link rel='shortlink' href='https://deblokt.com/?p=2663' />
<link rel="alternate" type="application/json+oembed" href="https://deblokt.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fdeblokt.com%2F2019%2F09%2F23%2F04-part-1-identityserver4-asp-net-core-identity%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://deblokt.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fdeblokt.com%2F2019%2F09%2F23%2F04-part-1-identityserver4-asp-net-core-identity%2F&#038;format=xml" />

	
		<script>
		(function(h,o,t,j,a,r){
			h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
			h._hjSettings={hjid:1569855,hjsv:5};
			a=o.getElementsByTagName('head')[0];
			r=o.createElement('script');r.async=1;
			r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
			a.appendChild(r);
		})(window,document,'//static.hotjar.com/c/hotjar-','.js?sv=');
		</script>
		
<!-- Facebook Pixel Code -->
<script type='text/javascript'>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
</script>
<!-- End Facebook Pixel Code -->
<script type='text/javascript'>
  fbq('init', '2416171941963882', [], {
    "agent": "wordpress-5.4-2.0.1"
});
</script><script type='text/javascript'>
  fbq('track', 'PageView', []);
</script>
<!-- Facebook Pixel Code -->
<noscript>
<img height="1" width="1" style="display:none" alt="fbpx"
src="https://www.facebook.com/tr?id=2416171941963882&ev=PageView&noscript=1" />
</noscript>
<!-- End Facebook Pixel Code -->
<meta name="generator" content="Powered by WPBakery Page Builder - drag and drop page builder for WordPress."/>
<!--[if lte IE 9]><link rel="stylesheet" type="text/css" href="https://deblokt.com/wp-content/plugins/js_composer/assets/css/vc_lte_ie9.min.css" media="screen"><![endif]-->		<style type="text/css" id="wp-custom-css">
			.error404 #header .section-heading {
		display: none;
}

header .intro-text .intro-lead-in {
    font-size: 34px;
}

#header {
		min-height: 450px;
}

.lower-footer {
    padding-top: 13px;
}

footer {
    padding: 0 0 10px 0;
}

header .intro-text .intro-heading {
    line-height: 30px;
}

header .intro-text .intro-lead-in {
    line-height: 50px;
}

section {
    padding: 100px 30px;
}

.homepage-masonry-grid .vc_gitem-animated-block {
    display: none;
}

.homepage-masonry-grid .vc_gitem-post-data-source-post_title > h4 {
		font-size: 1.5rem;
    font-weight: 600;
}

.homepage-masonry-grid .vc_gitem-zone {
    background: none !important;
		overflow: visible;
}

.homepage-masonry-grid .vc_gitem-zone p {
	font-size: 1.115rem;
}

.homepage-masonry-grid .vc_btn3-shape-rounded {
    background-color: #35AAE0 !important;
}

#posts-content .post p {
    font-size: 1.125em;
    line-height: 25px;
}

#posts-content .post h3 {
    font-size: 30px;
}

#posts-content .post .blog-single-title, #posts-content .blog-single-content .blog-single-title {
    font-size: 40px;
		line-height: 40px;
}

.subscribe input[type="submit"] {
    border: 1px solid #ccc;
		background-color: #f8f8f8;
}

.subscribe input[type="submit"]:hover {
    border: 1px solid #ccc;
		background-color: #f8f8f8;
}

.subscribe input {
    width: 400px;
    border-radius: 2px;
    height: 50px;
    line-height: 1;
    font-size: 0.875em;
    color: black;
    border: 1px solid rgba(255, 255, 255, 0.5);
    background-color: #f8f8f8;
    padding: 0 20px;
    border: 1px solid #ccc;
}

.subscribe input[type="email"]
{
	color: red;
}

.vc_column_container>.vc_column-inner {
    padding-top: 1%;
}

.testimonials.slider .tt-content h3 {
    font-size: 24px;
}

.pricing.active, .primary-button.button-inverse:hover, .primary-button.button-inverse {
    visibility: hidden;
} 

.primary-button {
	color: #fff;
  background-color: transparent!important;
}

.features-tabs .tabs {    
    margin-top: 0px;
}

.testimonials.slider .tt-content h3 {
    font-size: 1.3em;
}

@media (max-width: 1024px){
	.features-tabs .section-subheading {
			max-width: 550px;
	}
}

@media (min-width: 1025px){
	.features-tabs .section-subheading {
			max-width: 750px;
	}
}

.features-tabs img {
    box-shadow: 20px 25px 50px #464444;
    border-radius: 15px;
}

.features-tabs .tabs {
    margin-top: 40px;
}

.features-tabs li {
		background: url(wp-content/plugins/tt-vc-addon/assets/img/checked.png) no-repeat left 5px;
		font-size: 1em;
		line-height: 30px;
}

.features-tabs ul {
    margin-top: 20px;
}

.testimonials.slider .tt-quote {
    margin-top: -10px;
}

ul, ol {
    font-size: 1.125em;
}

#posts-content .post .blog-single-title, #posts-content .blog-single-content .blog-single-title {
    font-weight: bold;
}

@media (max-width: 1200px){
.features-tabs img {
    margin: 40px auto;
    max-width: 60%;
    position: relative;
    top: auto;
    right: auto;
    height: auto;
		visibility: hidden;
		display: none;
	}
}

@media (min-width: 960px){
		#header.image-bg .image-overlay {
			background-attachment: fixed;
			background-size: 100%;
			background-repeat: no-repeat;
			background-image: url("/wp-content/uploads/2019/09/headerImg.jpg")!important;
			position: absolute;
			background-position: top;
			width: 100%;
			height: 100%;
			top: 0;
			opacity: 0.25;
		}
}

@media (max-width: 960px){
		#header.image-bg .image-overlay {
			background-attachment: fixed;
			background-size: 100%;
			background-repeat: no-repeat;
			background-image: url("/wp-content/uploads/2019/09/Header2-819x1024.jpg")!important;
			position: absolute;
			background-position: top;
			width: 100%;
			height: 100%;
			top: 0;
			opacity: 0.25;
		}
}

.contact {
    width: 527px;
} 

@media (min-width: 768px){
	.vc_col-sm-12 {
		width: 107% !important;
	}
} 

@media (max-width: 1220px) {
	.contact {
    width: 100%;
    padding-top: 0px;
	}
}

@media (max-width: 1200px){ 
.wpcf7 .wpcf7-form {
    width: 100% !important;
    margin: auto;
	}
} 

@media (max-width: 1200px) {
	.row .contact p, section .section-subheading {
    	font-size: 1.125em !important;
	}
}

.elementor-section.elementor-section-stretched {
    padding-left: 0;
    padding-right: 0;
}

#wrapper {
			min-height: 95vh;
}

p {
    font-size: 1.125em;
} 

.nf-field-container {
    margin-bottom: 35px;
    width: 100%;
}

.nf-form-content {
    padding: 0px;
    margin: 0px;
		margin-top: 20px;
}

.nf-form-cont .one-half {
		margin-left: 0px;
}

.nf-form-cont .one-half, .nf-form-cont .three-sixths, .nf-form-cont .two-fourths {
    width: 100%;
}

.nf-field-description p:last-child {
    margin-bottom: 15px;
		margin-top: -8px;
}

@media only screen and (max-width: 800px) {
	.label-above .field-wrap, .label-below .field-wrap {
    margin-bottom: 35px;
	}
}

.nf-form-content button, .nf-form-content input[type=button], .nf-form-content input[type=submit] {
    background: #35AAE0;
		border-radius: 5px;
		text-transform: uppercase;
		width: 100%;
		font-weight: bold;
}

.nf-form-fields-required, .nf-error-msg nf-error-field-errors {
	display: none!important;
}

section#single-page.section.special-offer {
    padding: 70px 0px!important;
}

section#single-page.section.live-demo {
    padding: 70px 0px!important;
}

section#single-page.section.leads {
    padding: 70px 0px!important;
}

#our-video {
    background: url("/wp-content/uploads/2019/10/image-1.jpg") no-repeat center center fixed;
	-webkit-background-size: cover;
  -moz-background-size: cover;
  -o-background-size: cover;
  background-size: cover;
}

.header-buttons {
    margin: 80px auto 60px auto;
    font-size: large;
}

.header-buttons a {
		padding: 10px 40px;
		background-color: rgba(53, 170, 224, 0.6)!important;
}

ul.children {
	font-size: 14.22px!important;
}

ul.comment-list {
	font-size: 14.22px!important;
}		</style>
		<noscript><style type="text/css"> .wpb_animate_when_almost_visible { opacity: 1; }</style></noscript>      <link href="#" class="css-color" rel="stylesheet">
   </head>
   <body class="post-template-default single single-post postid-2663 single-format-standard subscribe-form wpb-js-composer js-comp-ver-5.5.5 vc_responsive elementor-default">
                    <nav class="navbar navbar-default navbar-fixed-top" role="navigation" >
         <div class="container">
            <div id="logo">
               <a class="logo" href="https://deblokt.com">
                              <img class="fixed-logo" src="https://deblokt.com/wp-content/uploads/2019/09/Deblokt-slova-belatransp.png" alt="" />
               </a>
            </div>
           <div class="navbar-header page-scroll">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-menu">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
            </div>
            <div id="main-menu" class="collapse navbar-collapse  navbar-right">
               <ul id="menu-main-menu" class="nav navbar-nav"><li id="menu-item-1857" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1857 one-page-link"><a title="Giving back" href="https://deblokt.com/home/giving-back/">Giving back</a></li>
<li id="menu-item-1822" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1822 one-page-link"><a title="Work" href="https://deblokt.com/home/work/">Work</a></li>
<li id="menu-item-1832" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1832 one-page-link"><a title="Team" href="https://deblokt.com/home/our-team/">Team</a></li>
<li id="menu-item-3036" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3036 one-page-link"><a title="Contact" href="https://deblokt.com/home/contact-2/">Contact</a></li>
<li id="menu-item-4220" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-4220"><a title="Case study" target="_blank" href="https://deblokt.com/wp-content/uploads/2020/01/DEBLOKT-FocustApps-Case-Study.pdf">Case study</a></li>
<li id="menu-item-3970" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-3970"><a title="Live demo" href="/live-demo/#single-page">Live demo</a></li>
</ul>            </div>
         </div>
      </nav>
      <div id="wrapper">
            
      <header id="header" class="blog-header" style="background-image:url('https://deblokt.com/wp-content/uploads/2019/09/PostLogo.jpg')">
         <div class="header-overlay"></div>
         <div class="container">
            <div class="intro-text">
                              <h2 class="section-heading">04. PART 1 IdentityServer4 ASP.NET Core Identity</h2>
                              <span class="separator" style="background:#ffffff"></span>
               <p class="section-subheading" style="color:#ffffff">&quot;An investment in knowledge always pays the best interest&quot; - Benjamin Franklin </p>
            </div>
         </div>
      </header>
      <div id="posts-content" class="container blog-single">
<div class="col-xs-12 col-sm-12 col-md-8 col-lg-8">
               <div class="post-2663 post type-post status-publish format-standard has-post-thumbnail hentry category-tutorials" id="post-2663">
         <div class="blog-single-content">
            <img width="1024" height="576" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src="https://deblokt.com/wp-content/uploads/2019/09/PostLogo-1024x576.jpg" class="lazy lazy-hidden attachment-large size-large wp-post-image" alt="" data-lazy-srcset="https://deblokt.com/wp-content/uploads/2019/09/PostLogo-1024x576.jpg 1024w, https://deblokt.com/wp-content/uploads/2019/09/PostLogo-300x169.jpg 300w, https://deblokt.com/wp-content/uploads/2019/09/PostLogo-768x432.jpg 768w, https://deblokt.com/wp-content/uploads/2019/09/PostLogo.jpg 1280w" data-lazy-sizes="(max-width: 1024px) 100vw, 1024px" /><noscript><img width="1024" height="576" src="https://deblokt.com/wp-content/uploads/2019/09/PostLogo-1024x576.jpg" class="attachment-large size-large wp-post-image" alt="" srcset="https://deblokt.com/wp-content/uploads/2019/09/PostLogo-1024x576.jpg 1024w, https://deblokt.com/wp-content/uploads/2019/09/PostLogo-300x169.jpg 300w, https://deblokt.com/wp-content/uploads/2019/09/PostLogo-768x432.jpg 768w, https://deblokt.com/wp-content/uploads/2019/09/PostLogo.jpg 1280w" sizes="(max-width: 1024px) 100vw, 1024px" /></noscript>            <h1 class="blog-single-title">04. PART 1 IdentityServer4 ASP.NET Core Identity</h1>
          <div class="entry-meta">
                        <span class="published">September 23, 2019</span><span class="blog-separator">|</span>
            <span class="author"><a href="https://deblokt.com/author/root/" title="Posts by deblokt" rel="author">deblokt</a></span><span class="blog-separator">|</span>                   
            <span class="blog-label">in category <a href="https://deblokt.com/category/tutorials/" rel="category tag">Tutorials</a></span>                    
            <span class="comment-count"><span class="fa fa-comment-o"></span><a href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#comments">8 comments</a></span>
         </div>
            <div class="blog-content"><p>You can find the project <a href="https://github.com/Deblokt/IdentityServer4Demos/tree/master/04.%20PART%201%20IdentityServer4%20ASP.NET%20Core%20Identity">here</a>.</p>
<h3><strong>What is ASP.NET Core Identity</strong></h3>
<p style="text-align: justify;">The official explanation from Microsoft docs is: “<em>ASP.NET Core Identity is a membership system that adds login functionality to ASP.NET Core apps. Users can create an account with the login information stored in Identity or they can use an external login provider.</em>” and “<em>Identity can be configured using a SQL Server database to store user names, passwords, and profile data.</em>”.</p>
<p style="text-align: justify;">So it is a membership system that takes care of members (another word for users) and it is used by ASP.NET Core apps (what we are building). Users can create local accounts stored in Identity (another name for user store) or can use any external provider like Google, Okta, Microsoft, Facebook, etc. User data can be persisted to a standard SQL database (which we already have). ASP.NET Identity standardizes user store with structure (tables) and methods to manipulate the store. For example to create a new user account, just invoke a method. It will validate the data and store it in a database. To log in, just invoke a login method, it will validate the password (for a local login) and return a valid response.</p>
<p style="text-align: justify;">To set or change the password, just invoke a method and the password will get hashed and stored in the database. <span style="font-size: inherit;">So a user store is a set of business logic contained in the methods that operate on data storage. The data structure of user tables is standardized so one day when ASP.NET Core is updated it will be easy to reuse existing tables or run a migration to another storage if needed.</span></p>
<p style="text-align: justify;">This is opposite to a custom user store where the data structure is custom so manual migration must be performed. Sometimes migration is not even possible because the password hashing algorithm used in the old and new store is different and there is no way to extract the plain text password from hashes and re-hash it. Business logic contained in methods for the ASP.NET Identity user store is tested, security standards are validated and are pretty much stable and secure as you can get it. It doesn’t cover all scenarios but it’s really easy to extend it as shown in one of my next tutorials where we will add a custom property to a user.</p>
<p>&nbsp;</p>
<h3><strong>Why do we even need ASP.NET Core Identity?</strong></h3>
<p style="text-align: justify;">We need it because IdentityServer4 doesn’t care about the users. It handles token generation, token endpoints, discovery endpoint, OAuth2 and OIDC protocols, clients, scopes, all the important bits except for the users. In order to get our Identity Server to start caring about the users (local and external), we should provide it with a user store.</p>
<p style="text-align: justify;">ASP.NET Identity is a good match as it’s a mature system for user management that is used by all ASP.NET applications, .net core and .net framework. You can use ASP.NET Core Identity without IdentityServer4 to authenticate single application but you lose the ability to create an Identity Provider (IdP) which is a whole point of these tutorials to have an SSO provider for all apps and not redo the auth for each app individually.</p>
<p>&nbsp;</p>
<h3><strong>Code changes in order to implement ASP.NET Core Identity</strong></h3>

<blockquote class="wp-block-quote">
<p>Note: I will continue on the previous <a href="/final/2019/09/20/02-identityserver4-entityframework/">“02. IdentityServer4 EntityFramework” tutorial</a> using the MSSQL server. For good people following the <a href="/final/2019/09/23/03-identityserver4-ef-with-postgresql/">PostgreSQL tutorial </a>all the steps that will be laid out in this tutorial are pretty much the same except you will use “UseNpgsql” instead of “UseSqlServer” extension method.</p>
</blockquote>



<blockquote class="wp-block-quote">
<p>Note 2: When we start doing scaffolding some CSS styles are going to be overwritten that will make IdentityServer4 look a bit weird and out of place. I suggest keeping a copy of “wwwroot/css” folder so you can overwrite the changes later on. Specific files that we need are “site.less”, “site.css” and “site.min.css”.</p>
</blockquote>

<p>&nbsp;</p>
<p style="text-align: justify;">Let’s start by adding a NuGet package for IdentityServer4 ASP.NET Core Identity support. The package name is “IdentityServer4.AspNetIdentity”.</p>
<p>&nbsp;</p>
<div id="envira-gallery-wrap-2670" class="envira-gallery-wrap envira-gallery-theme-base envira-lightbox-theme-base" itemscope itemtype="https://schema.org/ImageGallery"><div style="opacity: 0.0"  data-row-height="500" data-gallery-theme="normal" id="envira-gallery-2670" class="envira-gallery-public envira-gallery-justified-public envira-gallery-0-columns envira-clear enviratope envira-gallery-css-animations" data-envira-columns="0"><div id="envira-gallery-item-2671" class="envira-gallery-item enviratope-item envira-gallery-item-1" style="padding-left: 5px; padding-bottom: 10px; padding-right: 5px;"  itemscope itemtype="https://schema.org/ImageObject"><div class="envira-gallery-item-inner"><div class="envira-gallery-position-overlay  envira-gallery-top-left"></div><div class="envira-gallery-position-overlay  envira-gallery-top-right"></div><div class="envira-gallery-position-overlay  envira-gallery-bottom-left"></div><div class="envira-gallery-position-overlay  envira-gallery-bottom-right"></div><a href="https://deblokt.com/wp-content/uploads/2019/09/1-6.png" class="envira-gallery-2670 envira-gallery-link" rel="enviragallery2670" title="1" data-envira-caption="1" data-envira-retina="" data-thumbnail=""  itemprop="contentUrl"><img id="envira-gallery-image-2671" class="lazy lazy-hidden envira-gallery-image envira-gallery-image-1 envira-normal " data-envira-index="1" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src="https://deblokt.com/wp-content/uploads/2019/09/1-6-1024x578.png" data-envira-src="https://deblokt.com/wp-content/uploads/2019/09/1-6-1024x578.png" data-envira-gallery-id="2670" data-envira-item-id="2671" data-envira-caption="1" alt="" title="1"  itemprop="thumbnailUrl" data-envira-data-lazy-srcset="https://deblokt.com/wp-content/uploads/2019/09/1-6-1024x578.png 400w,https://deblokt.com/wp-content/uploads/2019/09/1-6-1024x578.png 2x" data-envira-width="300" data-envira-height="169" data-lazy-srcset="https://deblokt.com/wp-content/uploads/2019/09/1-6-2048x2048.png 2x" data-safe-src="https://deblokt.com/wp-content/uploads/2019/09/1-6-1024x578.png" /><noscript><img id="envira-gallery-image-2671" class="envira-gallery-image envira-gallery-image-1 envira-normal " data-envira-index="1" src="https://deblokt.com/wp-content/uploads/2019/09/1-6-1024x578.png" data-envira-src="https://deblokt.com/wp-content/uploads/2019/09/1-6-1024x578.png" data-envira-gallery-id="2670" data-envira-item-id="2671" data-envira-caption="1" alt="" title="1"  itemprop="thumbnailUrl" data-envira-srcset="https://deblokt.com/wp-content/uploads/2019/09/1-6-1024x578.png 400w,https://deblokt.com/wp-content/uploads/2019/09/1-6-1024x578.png 2x" data-envira-width="300" data-envira-height="169" srcset="https://deblokt.com/wp-content/uploads/2019/09/1-6-2048x2048.png 2x" data-safe-src="https://deblokt.com/wp-content/uploads/2019/09/1-6-1024x578.png" /></noscript></a></div></div></div></div><noscript><img src="https://deblokt.com/wp-content/uploads/2019/09/1-6.png" alt="" /></noscript>
<p style="text-align: justify;">Now we will add the ApplicationUser class that will inherit from the IdentityUser class. The reason for this is to be able to extend IdentityUser in the future (add additional properties to the user entity). In future tutorials, I will add an example of how to add <a href="/final/2019/09/27/05-identityserver4-adding-custom-properties-to-user/">custom user properties</a>. For now, we will just create a new folder called “Models” and add “ApplicationUser.cs” file to hold the class definition like so</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccb3031495965" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
using Microsoft.AspNetCore.Identity;

namespace IdentityServer.Models
{
	public class ApplicationUser : IdentityUser
	{
	
	}
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccb3031495965-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccb3031495965-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aaccb3031495965-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccb3031495965-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aaccb3031495965-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccb3031495965-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aaccb3031495965-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccb3031495965-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aaccb3031495965-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccb3031495965-1"><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-v">Microsoft</span><span class="crayon-sy">.</span><span class="crayon-v">AspNetCore</span><span class="crayon-sy">.</span><span class="crayon-v">Identity</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccb3031495965-2">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccb3031495965-3"><span class="crayon-t">namespace</span><span class="crayon-h"> </span><span class="crayon-v">IdentityServer</span><span class="crayon-sy">.</span><span class="crayon-i">Models</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccb3031495965-4"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccb3031495965-5"><span class="crayon-h">	</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-v">ApplicationUser</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">IdentityUser</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccb3031495965-6"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccb3031495965-7"><span class="crayon-h">	</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccb3031495965-8"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccb3031495965-9"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">The next step will scaffold MVC controllers and views for ASP.NET Identity. This step is not mandatory as the same functionality can be obtained by just using the NuGet package for ASP.NET Core Identity (“Microsoft.AspNetCore.Identity”). The difference is that scaffolding these resources in our project directly will allow for easy modification of the look and feel of ASP.NET Core Identity.</p>
<p>&nbsp;</p>
<p style="text-align: justify;">In Solution Explorer right-click on “Identity Server” project → Add → New Scaffolded Item</p>
<div id="envira-gallery-wrap-2674" class="envira-gallery-wrap envira-gallery-theme-base envira-lightbox-theme-base" itemscope itemtype="https://schema.org/ImageGallery"><div style="opacity: 0.0"  data-row-height="700" data-gallery-theme="normal" id="envira-gallery-2674" class="envira-gallery-public envira-gallery-justified-public envira-gallery-0-columns envira-clear enviratope envira-gallery-css-animations" data-envira-columns="0"><div id="envira-gallery-item-2675" class="envira-gallery-item enviratope-item envira-gallery-item-1" style="padding-left: 5px; padding-bottom: 10px; padding-right: 5px;"  itemscope itemtype="https://schema.org/ImageObject"><div class="envira-gallery-item-inner"><div class="envira-gallery-position-overlay  envira-gallery-top-left"></div><div class="envira-gallery-position-overlay  envira-gallery-top-right"></div><div class="envira-gallery-position-overlay  envira-gallery-bottom-left"></div><div class="envira-gallery-position-overlay  envira-gallery-bottom-right"></div><a href="https://deblokt.com/wp-content/uploads/2019/09/2-7.png" class="envira-gallery-2674 envira-gallery-link" rel="enviragallery2674" title="2" data-envira-caption="2" data-envira-retina="" data-thumbnail=""  itemprop="contentUrl"><img id="envira-gallery-image-2675" class="lazy lazy-hidden envira-gallery-image envira-gallery-image-1 envira-normal " data-envira-index="1" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src="https://deblokt.com/wp-content/uploads/2019/09/2-7-816x1024.png" data-envira-src="https://deblokt.com/wp-content/uploads/2019/09/2-7-816x1024.png" data-envira-gallery-id="2674" data-envira-item-id="2675" data-envira-caption="2" alt="" title="2"  itemprop="thumbnailUrl" data-envira-data-lazy-srcset="https://deblokt.com/wp-content/uploads/2019/09/2-7-816x1024.png 400w,https://deblokt.com/wp-content/uploads/2019/09/2-7-816x1024.png 2x" data-envira-width="239" data-envira-height="300" data-lazy-srcset="https://deblokt.com/wp-content/uploads/2019/09/2-7-2048x2048.png 2x" data-safe-src="https://deblokt.com/wp-content/uploads/2019/09/2-7-816x1024.png" /><noscript><img id="envira-gallery-image-2675" class="envira-gallery-image envira-gallery-image-1 envira-normal " data-envira-index="1" src="https://deblokt.com/wp-content/uploads/2019/09/2-7-816x1024.png" data-envira-src="https://deblokt.com/wp-content/uploads/2019/09/2-7-816x1024.png" data-envira-gallery-id="2674" data-envira-item-id="2675" data-envira-caption="2" alt="" title="2"  itemprop="thumbnailUrl" data-envira-srcset="https://deblokt.com/wp-content/uploads/2019/09/2-7-816x1024.png 400w,https://deblokt.com/wp-content/uploads/2019/09/2-7-816x1024.png 2x" data-envira-width="239" data-envira-height="300" srcset="https://deblokt.com/wp-content/uploads/2019/09/2-7-2048x2048.png 2x" data-safe-src="https://deblokt.com/wp-content/uploads/2019/09/2-7-816x1024.png" /></noscript></a></div></div></div></div><noscript><img src="https://deblokt.com/wp-content/uploads/2019/09/2-7.png" alt="" /></noscript>
<p>&nbsp;</p>
<p>The “Add Scaffold” dialog should pop-up, select “Identity” and click “Add”</p>
<div id="envira-gallery-wrap-2677" class="envira-gallery-wrap envira-gallery-theme-base envira-lightbox-theme-base" itemscope itemtype="https://schema.org/ImageGallery"><div style="opacity: 0.0"  data-row-height="600" data-gallery-theme="normal" id="envira-gallery-2677" class="envira-gallery-public envira-gallery-justified-public envira-gallery-0-columns envira-clear enviratope envira-gallery-css-animations" data-envira-columns="0"><div id="envira-gallery-item-2678" class="envira-gallery-item enviratope-item envira-gallery-item-1" style="padding-left: 5px; padding-bottom: 10px; padding-right: 5px;"  itemscope itemtype="https://schema.org/ImageObject"><div class="envira-gallery-item-inner"><div class="envira-gallery-position-overlay  envira-gallery-top-left"></div><div class="envira-gallery-position-overlay  envira-gallery-top-right"></div><div class="envira-gallery-position-overlay  envira-gallery-bottom-left"></div><div class="envira-gallery-position-overlay  envira-gallery-bottom-right"></div><a href="https://deblokt.com/wp-content/uploads/2019/09/3-4.png" class="envira-gallery-2677 envira-gallery-link" rel="enviragallery2677" title="3" data-envira-caption="3" data-envira-retina="" data-thumbnail=""  itemprop="contentUrl"><img id="envira-gallery-image-2678" class="lazy lazy-hidden envira-gallery-image envira-gallery-image-1 envira-normal " data-envira-index="1" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src="https://deblokt.com/wp-content/uploads/2019/09/3-4-1024x710.png" data-envira-src="https://deblokt.com/wp-content/uploads/2019/09/3-4-1024x710.png" data-envira-gallery-id="2677" data-envira-item-id="2678" data-envira-caption="3" alt="" title="3"  itemprop="thumbnailUrl" data-envira-data-lazy-srcset="https://deblokt.com/wp-content/uploads/2019/09/3-4-1024x710.png 400w,https://deblokt.com/wp-content/uploads/2019/09/3-4-1024x710.png 2x" data-envira-width="300" data-envira-height="208" data-lazy-srcset="https://deblokt.com/wp-content/uploads/2019/09/3-4-2048x2048.png 2x" data-safe-src="https://deblokt.com/wp-content/uploads/2019/09/3-4-1024x710.png" /><noscript><img id="envira-gallery-image-2678" class="envira-gallery-image envira-gallery-image-1 envira-normal " data-envira-index="1" src="https://deblokt.com/wp-content/uploads/2019/09/3-4-1024x710.png" data-envira-src="https://deblokt.com/wp-content/uploads/2019/09/3-4-1024x710.png" data-envira-gallery-id="2677" data-envira-item-id="2678" data-envira-caption="3" alt="" title="3"  itemprop="thumbnailUrl" data-envira-srcset="https://deblokt.com/wp-content/uploads/2019/09/3-4-1024x710.png 400w,https://deblokt.com/wp-content/uploads/2019/09/3-4-1024x710.png 2x" data-envira-width="300" data-envira-height="208" srcset="https://deblokt.com/wp-content/uploads/2019/09/3-4-2048x2048.png 2x" data-safe-src="https://deblokt.com/wp-content/uploads/2019/09/3-4-1024x710.png" /></noscript></a></div></div></div></div><noscript><img src="https://deblokt.com/wp-content/uploads/2019/09/3-4.png" alt="" /></noscript>
<p>&nbsp;</p>
<p style="text-align: justify;">The “Add Identity” dialog will pop-up. Select an existing Layout.cshtml file, in our project the location is “~/Views/Shared/_Layout.cshtml”. Click on “Override all files” checkbox to select all files. We need to create a new data context class, let’s call it “IdentityServer.Models.IdentityDbContext”. We will also specify the user class, so let’s use the “ApplicationUser” we added in the previous step.</p>
<div id="envira-gallery-wrap-2680" class="envira-gallery-wrap envira-gallery-theme-base envira-lightbox-theme-base" itemscope itemtype="https://schema.org/ImageGallery"><div style="opacity: 0.0"  data-row-height="500" data-gallery-theme="normal" id="envira-gallery-2680" class="envira-gallery-public envira-gallery-justified-public envira-gallery-0-columns envira-clear enviratope envira-gallery-css-animations" data-envira-columns="0"><div id="envira-gallery-item-2681" class="envira-gallery-item enviratope-item envira-gallery-item-1" style="padding-left: 5px; padding-bottom: 10px; padding-right: 5px;"  itemscope itemtype="https://schema.org/ImageObject"><div class="envira-gallery-item-inner"><div class="envira-gallery-position-overlay  envira-gallery-top-left"></div><div class="envira-gallery-position-overlay  envira-gallery-top-right"></div><div class="envira-gallery-position-overlay  envira-gallery-bottom-left"></div><div class="envira-gallery-position-overlay  envira-gallery-bottom-right"></div><a href="https://deblokt.com/wp-content/uploads/2019/09/4-4.png" class="envira-gallery-2680 envira-gallery-link" rel="enviragallery2680" title="4" data-envira-caption="4" data-envira-retina="" data-thumbnail=""  itemprop="contentUrl"><img id="envira-gallery-image-2681" class="lazy lazy-hidden envira-gallery-image envira-gallery-image-1 envira-normal " data-envira-index="1" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src="https://deblokt.com/wp-content/uploads/2019/09/4-4.png" data-envira-src="https://deblokt.com/wp-content/uploads/2019/09/4-4.png" data-envira-gallery-id="2680" data-envira-item-id="2681" data-envira-caption="4" alt="" title="4"  itemprop="thumbnailUrl" data-envira-data-lazy-srcset="https://deblokt.com/wp-content/uploads/2019/09/4-4.png 400w,https://deblokt.com/wp-content/uploads/2019/09/4-4.png 2x" data-envira-width="300" data-envira-height="272" data-lazy-srcset="https://deblokt.com/wp-content/uploads/2019/09/4-4-2048x2048.png 2x" data-safe-src="https://deblokt.com/wp-content/uploads/2019/09/4-4.png" /><noscript><img id="envira-gallery-image-2681" class="envira-gallery-image envira-gallery-image-1 envira-normal " data-envira-index="1" src="https://deblokt.com/wp-content/uploads/2019/09/4-4.png" data-envira-src="https://deblokt.com/wp-content/uploads/2019/09/4-4.png" data-envira-gallery-id="2680" data-envira-item-id="2681" data-envira-caption="4" alt="" title="4"  itemprop="thumbnailUrl" data-envira-srcset="https://deblokt.com/wp-content/uploads/2019/09/4-4.png 400w,https://deblokt.com/wp-content/uploads/2019/09/4-4.png 2x" data-envira-width="300" data-envira-height="272" srcset="https://deblokt.com/wp-content/uploads/2019/09/4-4-2048x2048.png 2x" data-safe-src="https://deblokt.com/wp-content/uploads/2019/09/4-4.png" /></noscript></a></div></div></div></div><noscript><img src="https://deblokt.com/wp-content/uploads/2019/09/4-4.png" alt="" /></noscript>
<p>&nbsp;</p>
<p style="text-align: justify;">Wait a bit for Visual Studio to do its magic and you should see a new folder called “Areas” containing all juicy ASP.NET Core views and controllers for us to play with.</p>
<div id="envira-gallery-wrap-2683" class="envira-gallery-wrap envira-gallery-theme-base envira-lightbox-theme-base" itemscope itemtype="https://schema.org/ImageGallery"><div style="opacity: 0.0"  data-row-height="900" data-gallery-theme="normal" id="envira-gallery-2683" class="envira-gallery-public envira-gallery-justified-public envira-gallery-0-columns envira-clear enviratope envira-gallery-css-animations" data-envira-columns="0"><div id="envira-gallery-item-2684" class="envira-gallery-item enviratope-item envira-gallery-item-1" style="padding-left: 5px; padding-bottom: 10px; padding-right: 5px;"  itemscope itemtype="https://schema.org/ImageObject"><div class="envira-gallery-item-inner"><div class="envira-gallery-position-overlay  envira-gallery-top-left"></div><div class="envira-gallery-position-overlay  envira-gallery-top-right"></div><div class="envira-gallery-position-overlay  envira-gallery-bottom-left"></div><div class="envira-gallery-position-overlay  envira-gallery-bottom-right"></div><a href="https://deblokt.com/wp-content/uploads/2019/09/5-3.png" class="envira-gallery-2683 envira-gallery-link" rel="enviragallery2683" title="5" data-envira-caption="5" data-envira-retina="" data-thumbnail=""  itemprop="contentUrl"><img id="envira-gallery-image-2684" class="lazy lazy-hidden envira-gallery-image envira-gallery-image-1 envira-normal " data-envira-index="1" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src="https://deblokt.com/wp-content/uploads/2019/09/5-3-350x1024.png" data-envira-src="https://deblokt.com/wp-content/uploads/2019/09/5-3-350x1024.png" data-envira-gallery-id="2683" data-envira-item-id="2684" data-envira-caption="5" alt="" title="5"  itemprop="thumbnailUrl" data-envira-data-lazy-srcset="https://deblokt.com/wp-content/uploads/2019/09/5-3-350x1024.png 400w,https://deblokt.com/wp-content/uploads/2019/09/5-3-350x1024.png 2x" data-envira-width="103" data-envira-height="300" data-lazy-srcset="https://deblokt.com/wp-content/uploads/2019/09/5-3-2048x2048.png 2x" data-safe-src="https://deblokt.com/wp-content/uploads/2019/09/5-3-350x1024.png" /><noscript><img id="envira-gallery-image-2684" class="envira-gallery-image envira-gallery-image-1 envira-normal " data-envira-index="1" src="https://deblokt.com/wp-content/uploads/2019/09/5-3-350x1024.png" data-envira-src="https://deblokt.com/wp-content/uploads/2019/09/5-3-350x1024.png" data-envira-gallery-id="2683" data-envira-item-id="2684" data-envira-caption="5" alt="" title="5"  itemprop="thumbnailUrl" data-envira-srcset="https://deblokt.com/wp-content/uploads/2019/09/5-3-350x1024.png 400w,https://deblokt.com/wp-content/uploads/2019/09/5-3-350x1024.png 2x" data-envira-width="103" data-envira-height="300" srcset="https://deblokt.com/wp-content/uploads/2019/09/5-3-2048x2048.png 2x" data-safe-src="https://deblokt.com/wp-content/uploads/2019/09/5-3-350x1024.png" /></noscript></a></div></div></div></div><noscript><img src="https://deblokt.com/wp-content/uploads/2019/09/5-3.png" alt="" /></noscript>
<p>&nbsp;</p>
<p style="text-align: justify;">Let’s just reorganize a bit for easier maintenance in the future. Move (drag and drop) “IdentityDbContext.cs” file from “Areas/Identity/Data” into the “Data” folder in the project root. You can now delete the “Areas/Identity/Data” folder.</p>
<p style="text-align: justify;">We will also simplify lambda expression in “Areas/Identity/IdentityHostingStartup.cs” as we will move that configuration into our project’s Startup in the next step. Better to keep all config as visible as possible and in one place. So open up “Areas/Identity/IdentityHostingStartup.cs” and leave only the Configure method like so</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccbd199202722" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
using Microsoft.AspNetCore.Hosting;
 
[assembly: HostingStartup(typeof(IdentityServer.Areas.Identity.IdentityHostingStartup))]

namespace IdentityServer.Areas.Identity
{
	public class IdentityHostingStartup : IHostingStartup
	{
		public void Configure(IWebHostBuilder builder)
		{
			builder.ConfigureServices((context, services) =&gt; {
			
			});
		}
	}
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccbd199202722-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccbd199202722-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aaccbd199202722-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccbd199202722-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aaccbd199202722-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccbd199202722-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aaccbd199202722-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccbd199202722-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aaccbd199202722-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccbd199202722-10">10</div><div class="crayon-num" data-line="crayon-5e94bd1aaccbd199202722-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccbd199202722-12">12</div><div class="crayon-num" data-line="crayon-5e94bd1aaccbd199202722-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccbd199202722-14">14</div><div class="crayon-num" data-line="crayon-5e94bd1aaccbd199202722-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccbd199202722-16">16</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccbd199202722-1"><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-v">Microsoft</span><span class="crayon-sy">.</span><span class="crayon-v">AspNetCore</span><span class="crayon-sy">.</span><span class="crayon-v">Hosting</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccbd199202722-2"><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5e94bd1aaccbd199202722-3"><span class="crayon-sy">[</span><span class="crayon-v">assembly</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">HostingStartup</span><span class="crayon-sy">(</span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">IdentityServer</span><span class="crayon-sy">.</span><span class="crayon-v">Areas</span><span class="crayon-sy">.</span><span class="crayon-v">Identity</span><span class="crayon-sy">.</span><span class="crayon-v">IdentityHostingStartup</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccbd199202722-4">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccbd199202722-5"><span class="crayon-t">namespace</span><span class="crayon-h"> </span><span class="crayon-v">IdentityServer</span><span class="crayon-sy">.</span><span class="crayon-v">Areas</span><span class="crayon-sy">.</span><span class="crayon-i">Identity</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccbd199202722-6"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccbd199202722-7"><span class="crayon-h">	</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-v">IdentityHostingStartup</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">IHostingStartup</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccbd199202722-8"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccbd199202722-9"><span class="crayon-h">		</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">Configure</span><span class="crayon-sy">(</span><span class="crayon-e">IWebHostBuilder </span><span class="crayon-v">builder</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccbd199202722-10"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccbd199202722-11"><span class="crayon-h">			</span><span class="crayon-v">builder</span><span class="crayon-sy">.</span><span class="crayon-e">ConfigureServices</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">services</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccbd199202722-12"><span class="crayon-h">			</span></div><div class="crayon-line" id="crayon-5e94bd1aaccbd199202722-13"><span class="crayon-h">			</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccbd199202722-14"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccbd199202722-15"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccbd199202722-16"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Last thing to remove is “Quickstart/TestUsers.cs” file that contains TestUsers class that initializes dummy users. We don’t need it anymore as when we finish all code changes the users will come from user store. Feel free to delete the “Quickstart/TestUsers.cs” file now.</p>
<p>Refactoring time. Open “Startup.cs” to add missing bits for ASP.NET Core Identity.</p>
<p>Add missing “using” directives</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccc0715208725" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
using IdentityServer.Models;
using Microsoft.AspNetCore.Identity;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccc0715208725-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc0715208725-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccc0715208725-1"><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-v">IdentityServer</span><span class="crayon-sy">.</span><span class="crayon-v">Models</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc0715208725-2"><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-v">Microsoft</span><span class="crayon-sy">.</span><span class="crayon-v">AspNetCore</span><span class="crayon-sy">.</span><span class="crayon-v">Identity</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Add code snippet for IdentityDbContext and ASP.NET Core Identity service (add it above the IdentityServer service configuration, above the “AddIdentityServer” extension method)</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccc3441862811" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
services.AddDbContext&lt;IdentityDbContext&gt;(options =&gt;
	options.UseSqlServer(connectionString, sql =&gt; sql.MigrationsAssembly(migrationsAssembly))
);

services.AddIdentity&lt;ApplicationUser, IdentityRole&gt;(options =&gt;
{
	options.SignIn.RequireConfirmedEmail = true;
})
.AddEntityFrameworkStores&lt;IdentityDbContext&gt;()
.AddDefaultTokenProviders();</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccc3441862811-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc3441862811-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc3441862811-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc3441862811-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc3441862811-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc3441862811-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc3441862811-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc3441862811-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc3441862811-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc3441862811-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccc3441862811-1"><span class="crayon-v">services</span><span class="crayon-sy">.</span><span class="crayon-v">AddDbContext</span><span class="crayon-o">&lt;</span><span class="crayon-v">IdentityDbContext</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">options</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc3441862811-2"><span class="crayon-h">	</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-e">UseSqlServer</span><span class="crayon-sy">(</span><span class="crayon-v">connectionString</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">sql</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">sql</span><span class="crayon-sy">.</span><span class="crayon-e">MigrationsAssembly</span><span class="crayon-sy">(</span><span class="crayon-v">migrationsAssembly</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc3441862811-3"><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc3441862811-4">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccc3441862811-5"><span class="crayon-v">services</span><span class="crayon-sy">.</span><span class="crayon-v">AddIdentity</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">IdentityRole</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">options</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc3441862811-6"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc3441862811-7"><span class="crayon-h">	</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">SignIn</span><span class="crayon-sy">.</span><span class="crayon-v">RequireConfirmedEmail</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc3441862811-8"><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc3441862811-9"><span class="crayon-sy">.</span><span class="crayon-v">AddEntityFrameworkStores</span><span class="crayon-o">&lt;</span><span class="crayon-v">IdentityDbContext</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc3441862811-10"><span class="crayon-sy">.</span><span class="crayon-e">AddDefaultTokenProviders</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Last thing to add in Startup is to add ASP.NET Core Identity to IdentityService service configuration (after the “AddOperationStore”)</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccc5073459237" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
.AddAspNetIdentity&lt;ApplicationUser&gt;();</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccc5073459237-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccc5073459237-1"><span class="crayon-sy">.</span><span class="crayon-v">AddAspNetIdentity</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">This is the complete ConfigureServices method body with ASP.NET Core Identity changes from above</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccc6963250926" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
public void ConfigureServices(IServiceCollection services)
{
	// uncomment, if you wan to add an MVC-based UI
	services.AddMvc().SetCompatibilityVersion(Microsoft.AspNetCore.Mvc.CompatibilityVersion.Version_2_1);

	string connectionString = Configuration.GetConnectionString("DefaultConnection");
	var migrationsAssembly = typeof(Startup).GetTypeInfo().Assembly.GetName().Name;

	services.AddDbContext&lt;IdentityDbContext&gt;(options =&gt;
		options.UseSqlServer(connectionString, sql =&gt; sql.MigrationsAssembly(migrationsAssembly))
	);

	services.AddIdentity&lt;ApplicationUser, IdentityRole&gt;(options =&gt;
	{
		options.SignIn.RequireConfirmedEmail = true;
	})
	.AddEntityFrameworkStores&lt;IdentityDbContext&gt;()
	.AddDefaultTokenProviders();

	var builder = services.AddIdentityServer(options =&gt;
	{
		options.Events.RaiseErrorEvents = true;
		options.Events.RaiseInformationEvents = true;
		options.Events.RaiseFailureEvents = true;
		options.Events.RaiseSuccessEvents = true;
		options.UserInteraction.LoginUrl = "/Account/Login";
		options.UserInteraction.LogoutUrl = "/Account/Logout";
		options.Authentication = new AuthenticationOptions()
		{
			CookieLifetime = TimeSpan.FromHours(10), // ID server cookie timeout set to 10 hours
			CookieSlidingExpiration = true
		};
	})
	.AddConfigurationStore(options =&gt;
	{
		options.ConfigureDbContext = b =&gt; b.UseSqlServer(connectionString, sql =&gt; sql.MigrationsAssembly(migrationsAssembly));
	})
	.AddOperationalStore(options =&gt;
	{
		options.ConfigureDbContext = b =&gt; b.UseSqlServer(connectionString, sql =&gt; sql.MigrationsAssembly(migrationsAssembly));
		options.EnableTokenCleanup = true;
	})
	.AddAspNetIdentity&lt;ApplicationUser&gt;();

	if (Environment.IsDevelopment())
	{
		builder.AddDeveloperSigningCredential();
	}
	else
	{
		throw new Exception("need to configure key material");
	}
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-10">10</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-12">12</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-14">14</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-16">16</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-18">18</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-20">20</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-22">22</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-24">24</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-26">26</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-28">28</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-30">30</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-32">32</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-34">34</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-36">36</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-38">38</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-40">40</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-42">42</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-44">44</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-46">46</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-48">48</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-50">50</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccc6963250926-52">52</div><div class="crayon-num" data-line="crayon-5e94bd1aaccc6963250926-53">53</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-1"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">ConfigureServices</span><span class="crayon-sy">(</span><span class="crayon-e">IServiceCollection </span><span class="crayon-v">services</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-2"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-3"><span class="crayon-h">	</span><span class="crayon-c">// uncomment, if you wan to add an MVC-based UI</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-4"><span class="crayon-h">	</span><span class="crayon-v">services</span><span class="crayon-sy">.</span><span class="crayon-e">AddMvc</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">SetCompatibilityVersion</span><span class="crayon-sy">(</span><span class="crayon-v">Microsoft</span><span class="crayon-sy">.</span><span class="crayon-v">AspNetCore</span><span class="crayon-sy">.</span><span class="crayon-v">Mvc</span><span class="crayon-sy">.</span><span class="crayon-v">CompatibilityVersion</span><span class="crayon-sy">.</span><span class="crayon-v">Version_2_1</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-6"><span class="crayon-h">	</span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-v">connectionString</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Configuration</span><span class="crayon-sy">.</span><span class="crayon-e">GetConnectionString</span><span class="crayon-sy">(</span><span class="crayon-s">"DefaultConnection"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-7"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">migrationsAssembly</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">Startup</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">GetTypeInfo</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">Assembly</span><span class="crayon-sy">.</span><span class="crayon-e">GetName</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-8">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-9"><span class="crayon-h">	</span><span class="crayon-v">services</span><span class="crayon-sy">.</span><span class="crayon-v">AddDbContext</span><span class="crayon-o">&lt;</span><span class="crayon-v">IdentityDbContext</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">options</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-10"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-e">UseSqlServer</span><span class="crayon-sy">(</span><span class="crayon-v">connectionString</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">sql</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">sql</span><span class="crayon-sy">.</span><span class="crayon-e">MigrationsAssembly</span><span class="crayon-sy">(</span><span class="crayon-v">migrationsAssembly</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-11"><span class="crayon-h">	</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-12">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-13"><span class="crayon-h">	</span><span class="crayon-v">services</span><span class="crayon-sy">.</span><span class="crayon-v">AddIdentity</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">IdentityRole</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">options</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-14"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-15"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">SignIn</span><span class="crayon-sy">.</span><span class="crayon-v">RequireConfirmedEmail</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-16"><span class="crayon-h">	</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-17"><span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">AddEntityFrameworkStores</span><span class="crayon-o">&lt;</span><span class="crayon-v">IdentityDbContext</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-18"><span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-e">AddDefaultTokenProviders</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-19">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-20"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">builder</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">services</span><span class="crayon-sy">.</span><span class="crayon-e">AddIdentityServer</span><span class="crayon-sy">(</span><span class="crayon-v">options</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-21"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-22"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">Events</span><span class="crayon-sy">.</span><span class="crayon-v">RaiseErrorEvents</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-23"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">Events</span><span class="crayon-sy">.</span><span class="crayon-v">RaiseInformationEvents</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-24"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">Events</span><span class="crayon-sy">.</span><span class="crayon-v">RaiseFailureEvents</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-25"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">Events</span><span class="crayon-sy">.</span><span class="crayon-v">RaiseSuccessEvents</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-26"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">UserInteraction</span><span class="crayon-sy">.</span><span class="crayon-v">LoginUrl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"/Account/Login"</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-27"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">UserInteraction</span><span class="crayon-sy">.</span><span class="crayon-v">LogoutUrl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"/Account/Logout"</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-28"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">Authentication</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">AuthenticationOptions</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-29"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-30"><span class="crayon-h">			</span><span class="crayon-v">CookieLifetime</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">TimeSpan</span><span class="crayon-sy">.</span><span class="crayon-e">FromHours</span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// ID server cookie timeout set to 10 hours</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-31"><span class="crayon-h">			</span><span class="crayon-v">CookieSlidingExpiration</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-32"><span class="crayon-h">		</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-33"><span class="crayon-h">	</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-34"><span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-e">AddConfigurationStore</span><span class="crayon-sy">(</span><span class="crayon-v">options</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-35"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-36"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">ConfigureDbContext</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">b</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">b</span><span class="crayon-sy">.</span><span class="crayon-e">UseSqlServer</span><span class="crayon-sy">(</span><span class="crayon-v">connectionString</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">sql</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">sql</span><span class="crayon-sy">.</span><span class="crayon-e">MigrationsAssembly</span><span class="crayon-sy">(</span><span class="crayon-v">migrationsAssembly</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-37"><span class="crayon-h">	</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-38"><span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-e">AddOperationalStore</span><span class="crayon-sy">(</span><span class="crayon-v">options</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-39"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-40"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">ConfigureDbContext</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">b</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">b</span><span class="crayon-sy">.</span><span class="crayon-e">UseSqlServer</span><span class="crayon-sy">(</span><span class="crayon-v">connectionString</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">sql</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">sql</span><span class="crayon-sy">.</span><span class="crayon-e">MigrationsAssembly</span><span class="crayon-sy">(</span><span class="crayon-v">migrationsAssembly</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-41"><span class="crayon-h">		</span><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">EnableTokenCleanup</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-42"><span class="crayon-h">	</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-43"><span class="crayon-h">	</span><span class="crayon-sy">.</span><span class="crayon-v">AddAspNetIdentity</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-44">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-45"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">Environment</span><span class="crayon-sy">.</span><span class="crayon-e">IsDevelopment</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-46"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-47"><span class="crayon-h">		</span><span class="crayon-v">builder</span><span class="crayon-sy">.</span><span class="crayon-e">AddDeveloperSigningCredential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-48"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-49"><span class="crayon-h">	</span><span class="crayon-st">else</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-50"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-51"><span class="crayon-h">		</span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Exception</span><span class="crayon-sy">(</span><span class="crayon-s">"need to configure key material"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccc6963250926-52"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccc6963250926-53"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">If you try to build the solution now you will get two errors one in “AccountController” and another in “ExternalController”. This is because we removed the “TestUsers” class and we need to update local login and external login controllers to use the ASP.NET Core Identity user store.</p>
<p>“Quickstart/Account/AccountController.cs” changes</p>
<p>Remove obsolete “using” directive</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccc9933492273" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
using IdentityServer4.Test;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccc9933492273-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccc9933492273-1"><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-v">IdentityServer4</span><span class="crayon-sy">.</span><span class="crayon-v">Test</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>&nbsp;</p>
<p>Add missing “using” directives</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aacccc378671702" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
using IdentityServer.Models;
using Microsoft.AspNetCore.Identity;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aacccc378671702-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacccc378671702-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aacccc378671702-1"><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-v">IdentityServer</span><span class="crayon-sy">.</span><span class="crayon-v">Models</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacccc378671702-2"><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-v">Microsoft</span><span class="crayon-sy">.</span><span class="crayon-v">AspNetCore</span><span class="crayon-sy">.</span><span class="crayon-v">Identity</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>&nbsp;</p>
<p>Remove obsolete variable</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccce261788460" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
private readonly TestUserStore _users;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccce261788460-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccce261788460-1"><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-m">readonly</span><span class="crayon-h"> </span><span class="crayon-e">TestUserStore </span><span class="crayon-v">_users</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Add private variables to hold injected references of UserManager and SignInManager</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccd0935694514" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
private readonly UserManager&lt;ApplicationUser&gt; _userManager;
private readonly SignInManager&lt;ApplicationUser&gt; _signInManager;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccd0935694514-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd0935694514-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccd0935694514-1"><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-m">readonly</span><span class="crayon-h"> </span><span class="crayon-v">UserManager</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">_userManager</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd0935694514-2"><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-m">readonly</span><span class="crayon-h"> </span><span class="crayon-v">SignInManager</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">_signInManager</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<p>&nbsp;</p>
<p>Replace the constructor with code below</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccd1849711696" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
public AccountController(
	UserManager&lt;ApplicationUser&gt; userManager,
	SignInManager&lt;ApplicationUser&gt; signInManager,
	IIdentityServerInteractionService interaction,
	IClientStore clientStore,
	IAuthenticationSchemeProvider schemeProvider,
	IEventService events)
{
	_userManager = userManager;
	_signInManager = signInManager;
	_interaction = interaction;
	_clientStore = clientStore;
	_schemeProvider = schemeProvider;
	_events = events;
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccd1849711696-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd1849711696-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd1849711696-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd1849711696-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd1849711696-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd1849711696-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd1849711696-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd1849711696-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd1849711696-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd1849711696-10">10</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd1849711696-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd1849711696-12">12</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd1849711696-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd1849711696-14">14</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd1849711696-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccd1849711696-1"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-e">AccountController</span><span class="crayon-sy">(</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd1849711696-2"><span class="crayon-h">	</span><span class="crayon-v">UserManager</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">userManager</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd1849711696-3"><span class="crayon-h">	</span><span class="crayon-v">SignInManager</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">signInManager</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd1849711696-4"><span class="crayon-h">	</span><span class="crayon-e">IIdentityServerInteractionService </span><span class="crayon-v">interaction</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd1849711696-5"><span class="crayon-h">	</span><span class="crayon-e">IClientStore </span><span class="crayon-v">clientStore</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd1849711696-6"><span class="crayon-h">	</span><span class="crayon-e">IAuthenticationSchemeProvider </span><span class="crayon-v">schemeProvider</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd1849711696-7"><span class="crayon-h">	</span><span class="crayon-e">IEventService </span><span class="crayon-v">events</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd1849711696-8"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd1849711696-9"><span class="crayon-h">	</span><span class="crayon-v">_userManager</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">userManager</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd1849711696-10"><span class="crayon-h">	</span><span class="crayon-v">_signInManager</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">signInManager</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd1849711696-11"><span class="crayon-h">	</span><span class="crayon-v">_interaction</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">interaction</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd1849711696-12"><span class="crayon-h">	</span><span class="crayon-v">_clientStore</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">clientStore</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd1849711696-13"><span class="crayon-h">	</span><span class="crayon-v">_schemeProvider</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">schemeProvider</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd1849711696-14"><span class="crayon-h">	</span><span class="crayon-v">_events</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">events</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd1849711696-15"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Replace second “Login” method with code below. This change will remove code that used the “TestUsers” class and use UserManager and SignInManager instead.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccd3184732343" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
public async Task&lt;IActionResult&gt; Login(LoginInputModel model, string button)
{
	// check if we are in the context of an authorization request
	var context = await _interaction.GetAuthorizationContextAsync(model.ReturnUrl);

	// the user clicked the "cancel" button
	if (button != "login")
	{
		if (context != null)
		{
			// if the user cancels, send a result back into IdentityServer as if they 
			// denied the consent (even if this client does not require consent).
			// this will send back an access denied OIDC error response to the client.
			await _interaction.GrantConsentAsync(context, ConsentResponse.Denied);

			// we can trust model.ReturnUrl since GetAuthorizationContextAsync returned non-null
			if (await _clientStore.IsPkceClientAsync(context.ClientId))
			{
				// if the client is PKCE then we assume it's native, so this change in how to
				// return the response is for better UX for the end user.
				return View("Redirect", new RedirectViewModel { RedirectUrl = model.ReturnUrl });
			}

			return Redirect(model.ReturnUrl);
		}
		else
		{
			// since we don't have a valid context, then we just go back to the home page
			return Redirect("~/");
		}
	}

	if (ModelState.IsValid)
	{
		var result = await _signInManager.PasswordSignInAsync(model.Username, model.Password, model.RememberLogin, lockoutOnFailure: true);
		if (result.Succeeded)
		{
			var user = await _userManager.FindByNameAsync(model.Username);
			await _events.RaiseAsync(new UserLoginSuccessEvent(user.UserName, user.Id, user.UserName));

			if (context != null)
			{
				if (await _clientStore.IsPkceClientAsync(context.ClientId))
				{
					// if the client is PKCE then we assume it's native, so this change in how to
					// return the response is for better UX for the end user.
					return View("Redirect", new RedirectViewModel { RedirectUrl = model.ReturnUrl });
				}

				// we can trust model.ReturnUrl since GetAuthorizationContextAsync returned non-null
				return Redirect(model.ReturnUrl);
			}

			// request for a local page
			if (Url.IsLocalUrl(model.ReturnUrl))
			{
				return Redirect(model.ReturnUrl);
			}
			else if (string.IsNullOrEmpty(model.ReturnUrl))
			{
				return Redirect("~/");
			}
			else
			{
				// user might have clicked on a malicious link - should be logged
				throw new Exception("invalid return URL");
			}
		}

		await _events.RaiseAsync(new UserLoginFailureEvent(model.Username, "invalid credentials"));
		ModelState.AddModelError(string.Empty, AccountOptions.InvalidCredentialsErrorMessage);
	}

	// something went wrong, show form with error
	var vm = await BuildLoginViewModelAsync(model);
	return View(vm);
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-10">10</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-12">12</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-14">14</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-16">16</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-18">18</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-20">20</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-22">22</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-24">24</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-26">26</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-28">28</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-30">30</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-32">32</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-34">34</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-36">36</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-38">38</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-40">40</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-42">42</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-44">44</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-46">46</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-48">48</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-50">50</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-52">52</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-54">54</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-56">56</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-58">58</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-60">60</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-62">62</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-64">64</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-66">66</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-68">68</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-70">70</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-72">72</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-74">74</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd3184732343-76">76</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd3184732343-77">77</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-1"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-m">async</span><span class="crayon-h"> </span><span class="crayon-v">Task</span><span class="crayon-o">&lt;</span><span class="crayon-v">IActionResult</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">Login</span><span class="crayon-sy">(</span><span class="crayon-e">LoginInputModel </span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-v">button</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-2"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-3"><span class="crayon-h">	</span><span class="crayon-c">// check if we are in the context of an authorization request</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-4"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">context</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_interaction</span><span class="crayon-sy">.</span><span class="crayon-e">GetAuthorizationContextAsync</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">ReturnUrl</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-6"><span class="crayon-h">	</span><span class="crayon-c">// the user clicked the "cancel" button</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-7"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">button</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-s">"login"</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-8"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-9"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-10"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-11"><span class="crayon-h">			</span><span class="crayon-c">// if the user cancels, send a result back into IdentityServer as if they </span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-12"><span class="crayon-h">			</span><span class="crayon-c">// denied the consent (even if this client does not require consent).</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-13"><span class="crayon-h">			</span><span class="crayon-c">// this will send back an access denied OIDC error response to the client.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-14"><span class="crayon-h">			</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_interaction</span><span class="crayon-sy">.</span><span class="crayon-e">GrantConsentAsync</span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ConsentResponse</span><span class="crayon-sy">.</span><span class="crayon-v">Denied</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-15">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-16"><span class="crayon-h">			</span><span class="crayon-c">// we can trust model.ReturnUrl since GetAuthorizationContextAsync returned non-null</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-17"><span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_clientStore</span><span class="crayon-sy">.</span><span class="crayon-e">IsPkceClientAsync</span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-v">ClientId</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-18"><span class="crayon-h">			</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-19"><span class="crayon-h">				</span><span class="crayon-c">// if the client is PKCE then we assume it's native, so this change in how to</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-20"><span class="crayon-h">				</span><span class="crayon-c">// return the response is for better UX for the end user.</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-21"><span class="crayon-h">				</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">View</span><span class="crayon-sy">(</span><span class="crayon-s">"Redirect"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">RedirectViewModel</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-v">RedirectUrl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-i">ReturnUrl</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-22"><span class="crayon-h">			</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-23">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-24"><span class="crayon-h">			</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">Redirect</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">ReturnUrl</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-25"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-26"><span class="crayon-h">		</span><span class="crayon-st">else</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-27"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-28"><span class="crayon-h">			</span><span class="crayon-c">// since we don't have a valid context, then we just go back to the home page</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-29"><span class="crayon-h">			</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">Redirect</span><span class="crayon-sy">(</span><span class="crayon-s">"~/"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-30"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-31"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-32">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-33"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">ModelState</span><span class="crayon-sy">.</span><span class="crayon-v">IsValid</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-34"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-35"><span class="crayon-h">		</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_signInManager</span><span class="crayon-sy">.</span><span class="crayon-e">PasswordSignInAsync</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">Username</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">Password</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">RememberLogin</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">lockoutOnFailure</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-36"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">.</span><span class="crayon-v">Succeeded</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-37"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-38"><span class="crayon-h">			</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_userManager</span><span class="crayon-sy">.</span><span class="crayon-e">FindByNameAsync</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">Username</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-39"><span class="crayon-h">			</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_events</span><span class="crayon-sy">.</span><span class="crayon-e">RaiseAsync</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">UserLoginSuccessEvent</span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-v">UserName</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-v">Id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-v">UserName</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-40">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-41"><span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-42"><span class="crayon-h">			</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-43"><span class="crayon-h">				</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_clientStore</span><span class="crayon-sy">.</span><span class="crayon-e">IsPkceClientAsync</span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-v">ClientId</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-44"><span class="crayon-h">				</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-45"><span class="crayon-h">					</span><span class="crayon-c">// if the client is PKCE then we assume it's native, so this change in how to</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-46"><span class="crayon-h">					</span><span class="crayon-c">// return the response is for better UX for the end user.</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-47"><span class="crayon-h">					</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">View</span><span class="crayon-sy">(</span><span class="crayon-s">"Redirect"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">RedirectViewModel</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-v">RedirectUrl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-i">ReturnUrl</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-48"><span class="crayon-h">				</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-49">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-50"><span class="crayon-h">				</span><span class="crayon-c">// we can trust model.ReturnUrl since GetAuthorizationContextAsync returned non-null</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-51"><span class="crayon-h">				</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">Redirect</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">ReturnUrl</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-52"><span class="crayon-h">			</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-53">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-54"><span class="crayon-h">			</span><span class="crayon-c">// request for a local page</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-55"><span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">Url</span><span class="crayon-sy">.</span><span class="crayon-e">IsLocalUrl</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">ReturnUrl</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-56"><span class="crayon-h">			</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-57"><span class="crayon-h">				</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">Redirect</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">ReturnUrl</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-58"><span class="crayon-h">			</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-59"><span class="crayon-h">			</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-e">IsNullOrEmpty</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">ReturnUrl</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-60"><span class="crayon-h">			</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-61"><span class="crayon-h">				</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">Redirect</span><span class="crayon-sy">(</span><span class="crayon-s">"~/"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-62"><span class="crayon-h">			</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-63"><span class="crayon-h">			</span><span class="crayon-st">else</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-64"><span class="crayon-h">			</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-65"><span class="crayon-h">				</span><span class="crayon-c">// user might have clicked on a malicious link - should be logged</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-66"><span class="crayon-h">				</span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Exception</span><span class="crayon-sy">(</span><span class="crayon-s">"invalid return URL"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-67"><span class="crayon-h">			</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-68"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-69">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-70"><span class="crayon-h">		</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_events</span><span class="crayon-sy">.</span><span class="crayon-e">RaiseAsync</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">UserLoginFailureEvent</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">Username</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"invalid credentials"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-71"><span class="crayon-h">		</span><span class="crayon-v">ModelState</span><span class="crayon-sy">.</span><span class="crayon-e">AddModelError</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-v">Empty</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">AccountOptions</span><span class="crayon-sy">.</span><span class="crayon-v">InvalidCredentialsErrorMessage</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-72"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-73">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-74"><span class="crayon-h">	</span><span class="crayon-c">// something went wrong, show form with error</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-75"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">vm</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-e">BuildLoginViewModelAsync</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd3184732343-76"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">View</span><span class="crayon-sy">(</span><span class="crayon-v">vm</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd3184732343-77"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Replace the second “Logout” method with code below. This change will use SignInManager for logout.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccd7886691445" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
public async Task&lt;IActionResult&gt; Logout(LogoutInputModel model)
{
	// build a model so the logged out page knows what to display
	var vm = await BuildLoggedOutViewModelAsync(model.LogoutId);

	if (User?.Identity.IsAuthenticated == true)
	{
		// delete local authentication cookie
		await _signInManager.SignOutAsync();

		// raise the logout event
		await _events.RaiseAsync(new UserLogoutSuccessEvent(User.GetSubjectId(), User.GetDisplayName()));
	}

	// check if we need to trigger sign-out at an upstream identity provider
	if (vm.TriggerExternalSignout)
	{
		// build a return URL so the upstream provider will redirect back
		// to us after the user has logged out. this allows us to then
		// complete our single sign-out processing.
		string url = Url.Action("Logout", new { logoutId = vm.LogoutId });

		// this triggers a redirect to the external provider for sign-out
		return SignOut(new AuthenticationProperties { RedirectUri = url }, vm.ExternalAuthenticationScheme);
	}

	return View("LoggedOut", vm);
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-10">10</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-12">12</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-14">14</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-16">16</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-18">18</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-20">20</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-22">22</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-24">24</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-26">26</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd7886691445-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd7886691445-28">28</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-1"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-m">async</span><span class="crayon-h"> </span><span class="crayon-v">Task</span><span class="crayon-o">&lt;</span><span class="crayon-v">IActionResult</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">Logout</span><span class="crayon-sy">(</span><span class="crayon-e">LogoutInputModel </span><span class="crayon-v">model</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-2"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-3"><span class="crayon-h">	</span><span class="crayon-c">// build a model so the logged out page knows what to display</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-4"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">vm</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-e">BuildLoggedOutViewModelAsync</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">LogoutId</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-6"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">User</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">Identity</span><span class="crayon-sy">.</span><span class="crayon-v">IsAuthenticated</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-7"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-8"><span class="crayon-h">		</span><span class="crayon-c">// delete local authentication cookie</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-9"><span class="crayon-h">		</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_signInManager</span><span class="crayon-sy">.</span><span class="crayon-e">SignOutAsync</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-10">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-11"><span class="crayon-h">		</span><span class="crayon-c">// raise the logout event</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-12"><span class="crayon-h">		</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_events</span><span class="crayon-sy">.</span><span class="crayon-e">RaiseAsync</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">UserLogoutSuccessEvent</span><span class="crayon-sy">(</span><span class="crayon-v">User</span><span class="crayon-sy">.</span><span class="crayon-e">GetSubjectId</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">User</span><span class="crayon-sy">.</span><span class="crayon-e">GetDisplayName</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-13"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-14">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-15"><span class="crayon-h">	</span><span class="crayon-c">// check if we need to trigger sign-out at an upstream identity provider</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-16"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">vm</span><span class="crayon-sy">.</span><span class="crayon-v">TriggerExternalSignout</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-17"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-18"><span class="crayon-h">		</span><span class="crayon-c">// build a return URL so the upstream provider will redirect back</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-19"><span class="crayon-h">		</span><span class="crayon-c">// to us after the user has logged out. this allows us to then</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-20"><span class="crayon-h">		</span><span class="crayon-c">// complete our single sign-out processing.</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-21"><span class="crayon-h">		</span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-v">url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Url</span><span class="crayon-sy">.</span><span class="crayon-e">Action</span><span class="crayon-sy">(</span><span class="crayon-s">"Logout"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-v">logoutId</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">vm</span><span class="crayon-sy">.</span><span class="crayon-i">LogoutId</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-22">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-23"><span class="crayon-h">		</span><span class="crayon-c">// this triggers a redirect to the external provider for sign-out</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-24"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">SignOut</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">AuthenticationProperties</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-v">RedirectUri</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">url</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vm</span><span class="crayon-sy">.</span><span class="crayon-v">ExternalAuthenticationScheme</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-25"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-26">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccd7886691445-27"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">View</span><span class="crayon-sy">(</span><span class="crayon-s">"LoggedOut"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vm</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd7886691445-28"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Last change in AccountController is to replace the “BuildLoginViewModelAsync” with the code below.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccd9593634698" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
private async Task&lt;LoginViewModel&gt; BuildLoginViewModelAsync(string returnUrl)
{
	var context = await _interaction.GetAuthorizationContextAsync(returnUrl);
	if (context?.IdP != null)
	{
		// this is meant to short circuit the UI and only trigger the one external IdP
		return new LoginViewModel
		{
			EnableLocalLogin = false,
			ReturnUrl = returnUrl,
			Username = context?.LoginHint,
			ExternalProviders = new ExternalProvider[] { new ExternalProvider { AuthenticationScheme = context.IdP } }
		};
	}

	var schemes = await _schemeProvider.GetAllSchemesAsync();

	var providers = schemes
		.Where(x =&gt; x.DisplayName != null ||
					(x.Name.Equals(AccountOptions.WindowsAuthenticationSchemeName, StringComparison.OrdinalIgnoreCase))
		)
		.Select(x =&gt; new ExternalProvider
		{
			DisplayName = x.DisplayName,
			AuthenticationScheme = x.Name
		}).ToList();

	var allowLocal = true;
	if (context?.ClientId != null)
	{
		var client = await _clientStore.FindEnabledClientByIdAsync(context.ClientId);
		if (client != null)
		{
			allowLocal = client.EnableLocalLogin;

			if (client.IdentityProviderRestrictions != null &amp;&amp; client.IdentityProviderRestrictions.Any())
			{
				providers = providers.Where(provider =&gt; client.IdentityProviderRestrictions.Contains(provider.AuthenticationScheme)).ToList();
			}
		}
	}

	return new LoginViewModel
	{
		AllowRememberLogin = AccountOptions.AllowRememberLogin,
		EnableLocalLogin = allowLocal &amp;&amp; AccountOptions.AllowLocalLogin,
		ReturnUrl = returnUrl,
		Username = context?.LoginHint,
		ExternalProviders = providers.ToArray()
	};
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-10">10</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-12">12</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-14">14</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-16">16</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-18">18</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-20">20</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-22">22</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-24">24</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-26">26</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-28">28</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-30">30</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-32">32</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-34">34</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-36">36</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-38">38</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-40">40</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-42">42</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-44">44</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-46">46</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-48">48</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccd9593634698-50">50</div><div class="crayon-num" data-line="crayon-5e94bd1aaccd9593634698-51">51</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-1"><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-m">async</span><span class="crayon-h"> </span><span class="crayon-v">Task</span><span class="crayon-o">&lt;</span><span class="crayon-v">LoginViewModel</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">BuildLoginViewModelAsync</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-v">returnUrl</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-2"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-3"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">context</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_interaction</span><span class="crayon-sy">.</span><span class="crayon-e">GetAuthorizationContextAsync</span><span class="crayon-sy">(</span><span class="crayon-v">returnUrl</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-4"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">IdP</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-5"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-6"><span class="crayon-h">		</span><span class="crayon-c">// this is meant to short circuit the UI and only trigger the one external IdP</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-7"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">LoginViewModel</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-8"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-9"><span class="crayon-h">			</span><span class="crayon-v">EnableLocalLogin</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-10"><span class="crayon-h">			</span><span class="crayon-v">ReturnUrl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">returnUrl</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-11"><span class="crayon-h">			</span><span class="crayon-v">Username</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">context</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">LoginHint</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-12"><span class="crayon-h">			</span><span class="crayon-v">ExternalProviders</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">ExternalProvider</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">ExternalProvider</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-v">AuthenticationScheme</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-i">IdP</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-13"><span class="crayon-h">		</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-14"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-15">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-16"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">schemes</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_schemeProvider</span><span class="crayon-sy">.</span><span class="crayon-e">GetAllSchemesAsync</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-17">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-18"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">providers</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">schemes</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-19"><span class="crayon-h">		</span><span class="crayon-sy">.</span><span class="crayon-e">Where</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">DisplayName</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-h"> </span><span class="crayon-o">||</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-20"><span class="crayon-h">					</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">.</span><span class="crayon-e">Equals</span><span class="crayon-sy">(</span><span class="crayon-v">AccountOptions</span><span class="crayon-sy">.</span><span class="crayon-v">WindowsAuthenticationSchemeName</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">StringComparison</span><span class="crayon-sy">.</span><span class="crayon-v">OrdinalIgnoreCase</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-21"><span class="crayon-h">		</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-22"><span class="crayon-h">		</span><span class="crayon-sy">.</span><span class="crayon-e">Select</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">ExternalProvider</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-23"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-24"><span class="crayon-h">			</span><span class="crayon-v">DisplayName</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">DisplayName</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-25"><span class="crayon-h">			</span><span class="crayon-v">AuthenticationScheme</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-i">Name</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-26"><span class="crayon-h">		</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">ToList</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-27">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-28"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">allowLocal</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-29"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">ClientId</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-30"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-31"><span class="crayon-h">		</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">client</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_clientStore</span><span class="crayon-sy">.</span><span class="crayon-e">FindEnabledClientByIdAsync</span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-sy">.</span><span class="crayon-v">ClientId</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-32"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">client</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-33"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-34"><span class="crayon-h">			</span><span class="crayon-v">allowLocal</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-v">EnableLocalLogin</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-35">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-36"><span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-v">IdentityProviderRestrictions</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-v">IdentityProviderRestrictions</span><span class="crayon-sy">.</span><span class="crayon-e">Any</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-37"><span class="crayon-h">			</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-38"><span class="crayon-h">				</span><span class="crayon-v">providers</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">providers</span><span class="crayon-sy">.</span><span class="crayon-e">Where</span><span class="crayon-sy">(</span><span class="crayon-v">provider</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-v">IdentityProviderRestrictions</span><span class="crayon-sy">.</span><span class="crayon-e">Contains</span><span class="crayon-sy">(</span><span class="crayon-v">provider</span><span class="crayon-sy">.</span><span class="crayon-v">AuthenticationScheme</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">ToList</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-39"><span class="crayon-h">			</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-40"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-41"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-42">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-43"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">LoginViewModel</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-44"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-45"><span class="crayon-h">		</span><span class="crayon-v">AllowRememberLogin</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">AccountOptions</span><span class="crayon-sy">.</span><span class="crayon-v">AllowRememberLogin</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-46"><span class="crayon-h">		</span><span class="crayon-v">EnableLocalLogin</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">allowLocal</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-v">AccountOptions</span><span class="crayon-sy">.</span><span class="crayon-v">AllowLocalLogin</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-47"><span class="crayon-h">		</span><span class="crayon-v">ReturnUrl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">returnUrl</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-48"><span class="crayon-h">		</span><span class="crayon-v">Username</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">context</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">LoginHint</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-49"><span class="crayon-h">		</span><span class="crayon-v">ExternalProviders</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">providers</span><span class="crayon-sy">.</span><span class="crayon-e">ToArray</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccd9593634698-50"><span class="crayon-h">	</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccd9593634698-51"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">AccountController is done. This will take care of the local login to use the ASP.NET Core Identity user store. Let’s work on the ExternalController now. An external controller handles external logins (from Okta, Google, Azure AD, etc.)</p>
<p style="text-align: justify;">“Quickstart/Account/ExternalController.cs” changes</p>
<p>Remove obsolete “using” directive</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccdc645631764" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
using IdentityServer4.Test;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccdc645631764-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccdc645631764-1"><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-v">IdentityServer4</span><span class="crayon-sy">.</span><span class="crayon-v">Test</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>&nbsp;</p>
<p>Add missing “using” directives</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccde872031539" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
using IdentityServer.Models;
using Microsoft.AspNetCore.Identity;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccde872031539-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccde872031539-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccde872031539-1"><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-v">IdentityServer</span><span class="crayon-sy">.</span><span class="crayon-v">Models</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccde872031539-2"><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-v">Microsoft</span><span class="crayon-sy">.</span><span class="crayon-v">AspNetCore</span><span class="crayon-sy">.</span><span class="crayon-v">Identity</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<p>&nbsp;</p>
<p>Remove obsolete variable</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccdf603056216" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
private readonly TestUserStore _users;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccdf603056216-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccdf603056216-1"><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-m">readonly</span><span class="crayon-h"> </span><span class="crayon-e">TestUserStore </span><span class="crayon-v">_users</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Add private variables to hold injected references of UserManager and SignInManager</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aacce1826668824" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
private readonly UserManager&lt;ApplicationUser&gt; _userManager;
private readonly SignInManager&lt;ApplicationUser&gt; _signInManager;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aacce1826668824-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce1826668824-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aacce1826668824-1"><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-m">readonly</span><span class="crayon-h"> </span><span class="crayon-v">UserManager</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">_userManager</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce1826668824-2"><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-m">readonly</span><span class="crayon-h"> </span><span class="crayon-v">SignInManager</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">_signInManager</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>&nbsp;</p>
<p>Replace the constructor with code below</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aacce2729833870" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
public ExternalController(
	UserManager&lt;ApplicationUser&gt; userManager,
	SignInManager&lt;ApplicationUser&gt; signInManager,
	IIdentityServerInteractionService interaction,
	IClientStore clientStore,
	IEventService events)
{
	_userManager = userManager;
	_signInManager = signInManager;
	_interaction = interaction;
	_clientStore = clientStore;
	_events = events;
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aacce2729833870-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce2729833870-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aacce2729833870-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce2729833870-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aacce2729833870-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce2729833870-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aacce2729833870-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce2729833870-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aacce2729833870-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce2729833870-10">10</div><div class="crayon-num" data-line="crayon-5e94bd1aacce2729833870-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce2729833870-12">12</div><div class="crayon-num" data-line="crayon-5e94bd1aacce2729833870-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aacce2729833870-1"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-e">ExternalController</span><span class="crayon-sy">(</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce2729833870-2"><span class="crayon-h">	</span><span class="crayon-v">UserManager</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">userManager</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5e94bd1aacce2729833870-3"><span class="crayon-h">	</span><span class="crayon-v">SignInManager</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">signInManager</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce2729833870-4"><span class="crayon-h">	</span><span class="crayon-e">IIdentityServerInteractionService </span><span class="crayon-v">interaction</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5e94bd1aacce2729833870-5"><span class="crayon-h">	</span><span class="crayon-e">IClientStore </span><span class="crayon-v">clientStore</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce2729833870-6"><span class="crayon-h">	</span><span class="crayon-e">IEventService </span><span class="crayon-v">events</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aacce2729833870-7"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce2729833870-8"><span class="crayon-h">	</span><span class="crayon-v">_userManager</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">userManager</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce2729833870-9"><span class="crayon-h">	</span><span class="crayon-v">_signInManager</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">signInManager</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce2729833870-10"><span class="crayon-h">	</span><span class="crayon-v">_interaction</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">interaction</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce2729833870-11"><span class="crayon-h">	</span><span class="crayon-v">_clientStore</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">clientStore</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce2729833870-12"><span class="crayon-h">	</span><span class="crayon-v">_events</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">events</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce2729833870-13"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Replace the “Callback” method with code below. This will help us split up functionality across several methods.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aacce4262293643" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
public async Task&lt;IActionResult&gt; Callback()
{
	// read external identity from the temporary cookie
	var result = await HttpContext.AuthenticateAsync(IdentityConstants.ExternalScheme);
	if (result?.Succeeded != true)
	{
		throw new Exception("External authentication error");
	}

	// lookup our user and external provider info
	var (user, provider, providerUserId, claims) = await FindUserFromExternalProviderAsync(result);
	if (user == null)
	{
		// this might be where you might initiate a custom workflow for user registration
		// in this sample we don't show how that would be done, as our sample implementation
		// simply auto-provisions new external user
		user = await AutoProvisionUserAsync(provider, providerUserId, claims);
	}

	// this allows us to collect any additonal claims or properties
	// for the specific prtotocols used and store them in the local auth cookie.
	// this is typically used to store data needed for signout from those protocols.
	var additionalLocalClaims = new List&lt;Claim&gt;();
	var localSignInProps = new AuthenticationProperties();
	ProcessLoginCallbackForOidc(result, additionalLocalClaims, localSignInProps);
	ProcessLoginCallbackForWsFed(result, additionalLocalClaims, localSignInProps);
	ProcessLoginCallbackForSaml2p(result, additionalLocalClaims, localSignInProps);

	// issue authentication cookie for user
	// we must issue the cookie maually, and can't use the SignInManager because
	// it doesn't expose an API to issue additional claims from the login workflow
	var principal = await _signInManager.CreateUserPrincipalAsync(user);
	additionalLocalClaims.AddRange(principal.Claims);
	var name = principal.FindFirst(JwtClaimTypes.Name)?.Value ?? user.Id;
	await _events.RaiseAsync(new UserLoginSuccessEvent(provider, providerUserId, user.Id, name));
	await HttpContext.SignInAsync(user.Id, name, provider, localSignInProps, additionalLocalClaims.ToArray());

	// delete temporary cookie used during external authentication
	await HttpContext.SignOutAsync(IdentityConstants.ExternalScheme);

	// validate return URL and redirect back to authorization endpoint or a local page
	var returnUrl = result.Properties.Items["returnUrl"];
	if (_interaction.IsValidReturnUrl(returnUrl) || Url.IsLocalUrl(returnUrl))
	{
		return Redirect(returnUrl);
	}

	return Redirect("~/");
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-10">10</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-12">12</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-14">14</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-16">16</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-18">18</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-20">20</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-22">22</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-24">24</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-26">26</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-28">28</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-30">30</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-32">32</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-34">34</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-36">36</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-38">38</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-40">40</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-42">42</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-44">44</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-46">46</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce4262293643-48">48</div><div class="crayon-num" data-line="crayon-5e94bd1aacce4262293643-49">49</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-1"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-m">async</span><span class="crayon-h"> </span><span class="crayon-v">Task</span><span class="crayon-o">&lt;</span><span class="crayon-v">IActionResult</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">Callback</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-2"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-3"><span class="crayon-h">	</span><span class="crayon-c">// read external identity from the temporary cookie</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-4"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">HttpContext</span><span class="crayon-sy">.</span><span class="crayon-e">AuthenticateAsync</span><span class="crayon-sy">(</span><span class="crayon-v">IdentityConstants</span><span class="crayon-sy">.</span><span class="crayon-v">ExternalScheme</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-5"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">Succeeded</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-6"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-7"><span class="crayon-h">		</span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Exception</span><span class="crayon-sy">(</span><span class="crayon-s">"External authentication error"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-8"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-10"><span class="crayon-h">	</span><span class="crayon-c">// lookup our user and external provider info</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-11"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">provider</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">providerUserId</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-e">FindUserFromExternalProviderAsync</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-12"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-13"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-14"><span class="crayon-h">		</span><span class="crayon-c">// this might be where you might initiate a custom workflow for user registration</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-15"><span class="crayon-h">		</span><span class="crayon-c">// in this sample we don't show how that would be done, as our sample implementation</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-16"><span class="crayon-h">		</span><span class="crayon-c">// simply auto-provisions new external user</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-17"><span class="crayon-h">		</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-e">AutoProvisionUserAsync</span><span class="crayon-sy">(</span><span class="crayon-v">provider</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">providerUserId</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-18"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-19">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-20"><span class="crayon-h">	</span><span class="crayon-c">// this allows us to collect any additonal claims or properties</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-21"><span class="crayon-h">	</span><span class="crayon-c">// for the specific prtotocols used and store them in the local auth cookie.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-22"><span class="crayon-h">	</span><span class="crayon-c">// this is typically used to store data needed for signout from those protocols.</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-23"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">additionalLocalClaims</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">List</span><span class="crayon-o">&lt;</span><span class="crayon-v">Claim</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-24"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">localSignInProps</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">AuthenticationProperties</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-25"><span class="crayon-h">	</span><span class="crayon-e">ProcessLoginCallbackForOidc</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">additionalLocalClaims</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">localSignInProps</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-26"><span class="crayon-h">	</span><span class="crayon-e">ProcessLoginCallbackForWsFed</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">additionalLocalClaims</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">localSignInProps</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-27"><span class="crayon-h">	</span><span class="crayon-e">ProcessLoginCallbackForSaml2p</span><span class="crayon-sy">(</span><span class="crayon-v">result</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">additionalLocalClaims</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">localSignInProps</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-28">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-29"><span class="crayon-h">	</span><span class="crayon-c">// issue authentication cookie for user</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-30"><span class="crayon-h">	</span><span class="crayon-c">// we must issue the cookie maually, and can't use the SignInManager because</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-31"><span class="crayon-h">	</span><span class="crayon-c">// it doesn't expose an API to issue additional claims from the login workflow</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-32"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">principal</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_signInManager</span><span class="crayon-sy">.</span><span class="crayon-e">CreateUserPrincipalAsync</span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-33"><span class="crayon-h">	</span><span class="crayon-v">additionalLocalClaims</span><span class="crayon-sy">.</span><span class="crayon-e">AddRange</span><span class="crayon-sy">(</span><span class="crayon-v">principal</span><span class="crayon-sy">.</span><span class="crayon-v">Claims</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-34"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">principal</span><span class="crayon-sy">.</span><span class="crayon-e">FindFirst</span><span class="crayon-sy">(</span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-i">Value</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-sy">?</span><span class="crayon-h"> </span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-v">Id</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-35"><span class="crayon-h">	</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_events</span><span class="crayon-sy">.</span><span class="crayon-e">RaiseAsync</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">UserLoginSuccessEvent</span><span class="crayon-sy">(</span><span class="crayon-v">provider</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">providerUserId</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-v">Id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-36"><span class="crayon-h">	</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">HttpContext</span><span class="crayon-sy">.</span><span class="crayon-e">SignInAsync</span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-v">Id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">provider</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">localSignInProps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">additionalLocalClaims</span><span class="crayon-sy">.</span><span class="crayon-e">ToArray</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-37">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-38"><span class="crayon-h">	</span><span class="crayon-c">// delete temporary cookie used during external authentication</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-39"><span class="crayon-h">	</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">HttpContext</span><span class="crayon-sy">.</span><span class="crayon-e">SignOutAsync</span><span class="crayon-sy">(</span><span class="crayon-v">IdentityConstants</span><span class="crayon-sy">.</span><span class="crayon-v">ExternalScheme</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-40">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-41"><span class="crayon-h">	</span><span class="crayon-c">// validate return URL and redirect back to authorization endpoint or a local page</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-42"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">returnUrl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">.</span><span class="crayon-v">Properties</span><span class="crayon-sy">.</span><span class="crayon-v">Items</span><span class="crayon-sy">[</span><span class="crayon-s">"returnUrl"</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-43"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">_interaction</span><span class="crayon-sy">.</span><span class="crayon-e">IsValidReturnUrl</span><span class="crayon-sy">(</span><span class="crayon-v">returnUrl</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">||</span><span class="crayon-h"> </span><span class="crayon-v">Url</span><span class="crayon-sy">.</span><span class="crayon-e">IsLocalUrl</span><span class="crayon-sy">(</span><span class="crayon-v">returnUrl</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-44"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-45"><span class="crayon-h">		</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">Redirect</span><span class="crayon-sy">(</span><span class="crayon-v">returnUrl</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-46"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-47">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce4262293643-48"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">Redirect</span><span class="crayon-sy">(</span><span class="crayon-s">"~/"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce4262293643-49"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Replace the “FindUserFromExternalProviderAsync” method with code below. It will add couple more ways to match local user with the external user using different claims like name, email, preferred name.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aacce7349437880" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
private async Task&lt;(ApplicationUser user, string provider, string providerUserId, IEnumerable&lt;Claim&gt; claims)&gt;
	FindUserFromExternalProviderAsync(AuthenticateResult result)
{
	var externalUser = result.Principal;

	// try to determine the unique id of the external user (issued by the provider)
	// the most common claim type for that are the sub claim and the NameIdentifier
	// depending on the external provider, some other claim type might be used
	var userIdClaim = externalUser.FindFirst(JwtClaimTypes.Subject) ??
					  externalUser.FindFirst(ClaimTypes.NameIdentifier) ??
					  throw new Exception("Unknown userid");

	// remove the user id claim so we don't include it as an extra claim if/when we provision the user
	var claims = externalUser.Claims.ToList();
	claims.Remove(userIdClaim);

	var provider = result.Properties.Items["scheme"];
	var providerUserId = userIdClaim.Value;

	// find external user
	var user = await _userManager.FindByLoginAsync(provider, providerUserId);

	// try to find user by name and/or email
	if (user == null)
	{
		var name = claims.FirstOrDefault(x =&gt; x.Type == JwtClaimTypes.Name)?.Value ?? claims.FirstOrDefault(x =&gt; x.Type == ClaimTypes.Name)?.Value;
		if (name != null)
		{
			user = await _userManager.FindByNameAsync(name);
		}
		if (user == null)
		{
			var prefname = claims.FirstOrDefault(x =&gt; x.Type == JwtClaimTypes.PreferredUserName)?.Value;
			if (prefname != null)
			{
				user = await _userManager.FindByNameAsync(prefname);
			}
		}
		if (user == null)
		{
			var email = claims.FirstOrDefault(x =&gt; x.Type == JwtClaimTypes.Email)?.Value ?? claims.FirstOrDefault(x =&gt; x.Type == ClaimTypes.Email)?.Value;
			if (email != null)
			{
				user = await _userManager.FindByEmailAsync(email);
			}
		}
		if (user != null)
		{
			var identityResult = await _userManager.AddLoginAsync(user, new UserLoginInfo(provider, providerUserId, provider));
			if (!identityResult.Succeeded) throw new Exception(identityResult.Errors.First().Description);
		}
	}

	return (user, provider, providerUserId, claims);
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-10">10</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-12">12</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-14">14</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-16">16</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-18">18</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-20">20</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-22">22</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-24">24</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-26">26</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-28">28</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-30">30</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-32">32</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-34">34</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-36">36</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-38">38</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-40">40</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-42">42</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-44">44</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-46">46</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-48">48</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-50">50</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-52">52</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aacce7349437880-54">54</div><div class="crayon-num" data-line="crayon-5e94bd1aacce7349437880-55">55</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-1"><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-m">async</span><span class="crayon-h"> </span><span class="crayon-v">Task</span><span class="crayon-o">&lt;</span><span class="crayon-sy">(</span><span class="crayon-e">ApplicationUser </span><span class="crayon-v">user</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-v">provider</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-v">providerUserId</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">IEnumerable</span><span class="crayon-o">&lt;</span><span class="crayon-v">Claim</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-2"><span class="crayon-h">	</span><span class="crayon-e">FindUserFromExternalProviderAsync</span><span class="crayon-sy">(</span><span class="crayon-e">AuthenticateResult </span><span class="crayon-v">result</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-3"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-4"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">externalUser</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">.</span><span class="crayon-v">Principal</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-6"><span class="crayon-h">	</span><span class="crayon-c">// try to determine the unique id of the external user (issued by the provider)</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-7"><span class="crayon-h">	</span><span class="crayon-c">// the most common claim type for that are the sub claim and the NameIdentifier</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-8"><span class="crayon-h">	</span><span class="crayon-c">// depending on the external provider, some other claim type might be used</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-9"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">userIdClaim</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">externalUser</span><span class="crayon-sy">.</span><span class="crayon-e">FindFirst</span><span class="crayon-sy">(</span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Subject</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-sy">?</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-10"><span class="crayon-h">					&nbsp;&nbsp;</span><span class="crayon-v">externalUser</span><span class="crayon-sy">.</span><span class="crayon-e">FindFirst</span><span class="crayon-sy">(</span><span class="crayon-v">ClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">NameIdentifier</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-sy">?</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-11"><span class="crayon-h">					&nbsp;&nbsp;</span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Exception</span><span class="crayon-sy">(</span><span class="crayon-s">"Unknown userid"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-12">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-13"><span class="crayon-h">	</span><span class="crayon-c">// remove the user id claim so we don't include it as an extra claim if/when we provision the user</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-14"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">externalUser</span><span class="crayon-sy">.</span><span class="crayon-v">Claims</span><span class="crayon-sy">.</span><span class="crayon-e">ToList</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-15"><span class="crayon-h">	</span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">Remove</span><span class="crayon-sy">(</span><span class="crayon-v">userIdClaim</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-16">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-17"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">provider</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">result</span><span class="crayon-sy">.</span><span class="crayon-v">Properties</span><span class="crayon-sy">.</span><span class="crayon-v">Items</span><span class="crayon-sy">[</span><span class="crayon-s">"scheme"</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-18"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">providerUserId</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">userIdClaim</span><span class="crayon-sy">.</span><span class="crayon-v">Value</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-19">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-20"><span class="crayon-h">	</span><span class="crayon-c">// find external user</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-21"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_userManager</span><span class="crayon-sy">.</span><span class="crayon-e">FindByLoginAsync</span><span class="crayon-sy">(</span><span class="crayon-v">provider</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">providerUserId</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-22">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-23"><span class="crayon-h">	</span><span class="crayon-c">// try to find user by name and/or email</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-24"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-25"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-26"><span class="crayon-h">		</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-i">Value</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-sy">?</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">ClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">Value</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-27"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-28"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-29"><span class="crayon-h">			</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_userManager</span><span class="crayon-sy">.</span><span class="crayon-e">FindByNameAsync</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-30"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-31"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-32"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-33"><span class="crayon-h">			</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">prefname</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">PreferredUserName</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">Value</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-34"><span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">prefname</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-35"><span class="crayon-h">			</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-36"><span class="crayon-h">				</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_userManager</span><span class="crayon-sy">.</span><span class="crayon-e">FindByNameAsync</span><span class="crayon-sy">(</span><span class="crayon-v">prefname</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-37"><span class="crayon-h">			</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-38"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-39"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-40"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-41"><span class="crayon-h">			</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">email</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Email</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-i">Value</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-sy">?</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">ClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Email</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">Value</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-42"><span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">email</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-43"><span class="crayon-h">			</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-44"><span class="crayon-h">				</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_userManager</span><span class="crayon-sy">.</span><span class="crayon-e">FindByEmailAsync</span><span class="crayon-sy">(</span><span class="crayon-v">email</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-45"><span class="crayon-h">			</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-46"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-47"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-48"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-49"><span class="crayon-h">			</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">identityResult</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_userManager</span><span class="crayon-sy">.</span><span class="crayon-e">AddLoginAsync</span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">UserLoginInfo</span><span class="crayon-sy">(</span><span class="crayon-v">provider</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">providerUserId</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">provider</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-50"><span class="crayon-h">			</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">identityResult</span><span class="crayon-sy">.</span><span class="crayon-v">Succeeded</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Exception</span><span class="crayon-sy">(</span><span class="crayon-v">identityResult</span><span class="crayon-sy">.</span><span class="crayon-v">Errors</span><span class="crayon-sy">.</span><span class="crayon-e">First</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">Description</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-51"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-52"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-53">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aacce7349437880-54"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">provider</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">providerUserId</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aacce7349437880-55"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0025 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Finally, the last change is to replace the “AutoProvisionUser” method with the code below. This method is in charge of creating a new local user for the external user login if the local user couldn’t be found in the local user store.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccea853080333" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
private async Task&lt;ApplicationUser&gt; AutoProvisionUserAsync(string provider, string providerUserId, IEnumerable&lt;Claim&gt; claims)
{
	// create a list of claims that we want to transfer into our store
	var filtered = new List&lt;Claim&gt;();

	// user's display name
	var name = claims.FirstOrDefault(x =&gt; x.Type == JwtClaimTypes.Name)?.Value ??
		claims.FirstOrDefault(x =&gt; x.Type == ClaimTypes.Name)?.Value;
	if (name != null)
	{
		filtered.Add(new Claim(JwtClaimTypes.Name, name));
	}
	else
	{
		var first = claims.FirstOrDefault(x =&gt; x.Type == JwtClaimTypes.GivenName)?.Value ??
			claims.FirstOrDefault(x =&gt; x.Type == ClaimTypes.GivenName)?.Value;
		var last = claims.FirstOrDefault(x =&gt; x.Type == JwtClaimTypes.FamilyName)?.Value ??
			claims.FirstOrDefault(x =&gt; x.Type == ClaimTypes.Surname)?.Value;
		if (first != null &amp;&amp; last != null)
		{
			filtered.Add(new Claim(JwtClaimTypes.Name, first + " " + last));
		}
		else if (first != null)
		{
			filtered.Add(new Claim(JwtClaimTypes.Name, first));
		}
		else if (last != null)
		{
			filtered.Add(new Claim(JwtClaimTypes.Name, last));
		}
	}

	// email
	var email = claims.FirstOrDefault(x =&gt; x.Type == JwtClaimTypes.Email)?.Value ??
	   claims.FirstOrDefault(x =&gt; x.Type == ClaimTypes.Email)?.Value;
	if (email != null)
	{
		filtered.Add(new Claim(JwtClaimTypes.Email, email));
	}

	var user = new ApplicationUser
	{
		UserName = Guid.NewGuid().ToString(),
	};
	var identityResult = await _userManager.CreateAsync(user);
	if (!identityResult.Succeeded) throw new Exception(identityResult.Errors.First().Description);

	if (filtered.Any())
	{
		identityResult = await _userManager.AddClaimsAsync(user, filtered);
		if (!identityResult.Succeeded) throw new Exception(identityResult.Errors.First().Description);
	}

	identityResult = await _userManager.AddLoginAsync(user, new UserLoginInfo(provider, providerUserId, provider));
	if (!identityResult.Succeeded) throw new Exception(identityResult.Errors.First().Description);

	return user;
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-2">2</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-4">4</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-6">6</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-8">8</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-10">10</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-12">12</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-14">14</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-16">16</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-18">18</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-20">20</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-22">22</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-24">24</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-26">26</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-28">28</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-30">30</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-32">32</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-34">34</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-36">36</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-38">38</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-40">40</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-42">42</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-44">44</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-46">46</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-48">48</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-50">50</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-52">52</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-54">54</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-56">56</div><div class="crayon-num" data-line="crayon-5e94bd1aaccea853080333-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccea853080333-58">58</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-1"><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-m">async</span><span class="crayon-h"> </span><span class="crayon-v">Task</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApplicationUser</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">AutoProvisionUserAsync</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-v">provider</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-v">providerUserId</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">IEnumerable</span><span class="crayon-o">&lt;</span><span class="crayon-v">Claim</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-2"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-3"><span class="crayon-h">	</span><span class="crayon-c">// create a list of claims that we want to transfer into our store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-4"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">filtered</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">List</span><span class="crayon-o">&lt;</span><span class="crayon-v">Claim</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-6"><span class="crayon-h">	</span><span class="crayon-c">// user's display name</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-7"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-i">Value</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-sy">?</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-8"><span class="crayon-h">		</span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">ClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">Value</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-9"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-10"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-11"><span class="crayon-h">		</span><span class="crayon-v">filtered</span><span class="crayon-sy">.</span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Claim</span><span class="crayon-sy">(</span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-12"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-13"><span class="crayon-h">	</span><span class="crayon-st">else</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-14"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-15"><span class="crayon-h">		</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">first</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">GivenName</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-i">Value</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-sy">?</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-16"><span class="crayon-h">			</span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">ClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">GivenName</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">Value</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-17"><span class="crayon-h">		</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">last</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">FamilyName</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-i">Value</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-sy">?</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-18"><span class="crayon-h">			</span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">ClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Surname</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">Value</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-19"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">first</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-v">last</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-20"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-21"><span class="crayon-h">			</span><span class="crayon-v">filtered</span><span class="crayon-sy">.</span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Claim</span><span class="crayon-sy">(</span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">first</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">" "</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">last</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-22"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-23"><span class="crayon-h">		</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">first</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-24"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-25"><span class="crayon-h">			</span><span class="crayon-v">filtered</span><span class="crayon-sy">.</span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Claim</span><span class="crayon-sy">(</span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">first</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-26"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-27"><span class="crayon-h">		</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">last</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-28"><span class="crayon-h">		</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-29"><span class="crayon-h">			</span><span class="crayon-v">filtered</span><span class="crayon-sy">.</span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Claim</span><span class="crayon-sy">(</span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">last</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-30"><span class="crayon-h">		</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-31"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-32">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-33"><span class="crayon-h">	</span><span class="crayon-c">// email</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-34"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">email</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Email</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-i">Value</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-sy">?</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-35"><span class="crayon-h">	&nbsp;&nbsp; </span><span class="crayon-v">claims</span><span class="crayon-sy">.</span><span class="crayon-e">FirstOrDefault</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">Type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">ClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Email</span><span class="crayon-sy">)</span><span class="crayon-sy">?</span><span class="crayon-sy">.</span><span class="crayon-v">Value</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-36"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">email</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-37"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-38"><span class="crayon-h">		</span><span class="crayon-v">filtered</span><span class="crayon-sy">.</span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Claim</span><span class="crayon-sy">(</span><span class="crayon-v">JwtClaimTypes</span><span class="crayon-sy">.</span><span class="crayon-v">Email</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">email</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-39"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-40">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-41"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">ApplicationUser</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-42"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-43"><span class="crayon-h">		</span><span class="crayon-v">UserName</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Guid</span><span class="crayon-sy">.</span><span class="crayon-e">NewGuid</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-44"><span class="crayon-h">	</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-45"><span class="crayon-h">	</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">identityResult</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_userManager</span><span class="crayon-sy">.</span><span class="crayon-e">CreateAsync</span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-46"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">identityResult</span><span class="crayon-sy">.</span><span class="crayon-v">Succeeded</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Exception</span><span class="crayon-sy">(</span><span class="crayon-v">identityResult</span><span class="crayon-sy">.</span><span class="crayon-v">Errors</span><span class="crayon-sy">.</span><span class="crayon-e">First</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">Description</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-47">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-48"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">filtered</span><span class="crayon-sy">.</span><span class="crayon-e">Any</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-49"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-50"><span class="crayon-h">		</span><span class="crayon-v">identityResult</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_userManager</span><span class="crayon-sy">.</span><span class="crayon-e">AddClaimsAsync</span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">filtered</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-51"><span class="crayon-h">		</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">identityResult</span><span class="crayon-sy">.</span><span class="crayon-v">Succeeded</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Exception</span><span class="crayon-sy">(</span><span class="crayon-v">identityResult</span><span class="crayon-sy">.</span><span class="crayon-v">Errors</span><span class="crayon-sy">.</span><span class="crayon-e">First</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">Description</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-52"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-53">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-54"><span class="crayon-h">	</span><span class="crayon-v">identityResult</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">_userManager</span><span class="crayon-sy">.</span><span class="crayon-e">AddLoginAsync</span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">UserLoginInfo</span><span class="crayon-sy">(</span><span class="crayon-v">provider</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">providerUserId</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">provider</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-55"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">identityResult</span><span class="crayon-sy">.</span><span class="crayon-v">Succeeded</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Exception</span><span class="crayon-sy">(</span><span class="crayon-v">identityResult</span><span class="crayon-sy">.</span><span class="crayon-v">Errors</span><span class="crayon-sy">.</span><span class="crayon-e">First</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">Description</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-56">&nbsp;</div><div class="crayon-line" id="crayon-5e94bd1aaccea853080333-57"><span class="crayon-h">	</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">user</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccea853080333-58"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0036 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">Phew. That was quite a load of work to do. ExternalController is done. The project should be able to build now as we removed all references to the “TestUsers” class.</p>
<p>&nbsp;</p>
<h3 style="text-align: justify;"><strong>More details</strong></h3>
<p style="text-align: justify;">Let’s recap. So we removed the “TestUsers” class that contained hardcoded users. We added NuGet packages for ASP.NET Core Identity. We scaffolded views and controllers for ASP.NET Core Identity that will allow us to modify them in the future. They are responsible for a password reset, 2FA, user registration, etc so it’s a good thing to have them in solution ready for any modification needed. One important thing to notice is that we will not be using Login and Logout controller/view from ASP.NET Core Identity because we will use those provided by IdentityServer4. We actually specified this in Startup</p>
<p>&nbsp;</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e94bd1aaccee765005617" class="crayon-syntax crayon-theme-eclipse crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 18px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 15px !important;height: 22.5px !important; line-height: 22.5px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C#</span></div></div>
			<div class="crayon-info" style="min-height: 21px !important; line-height: 21px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 15px !important; line-height: 18px !important;">
options.UserInteraction.LoginUrl = "/Account/Login";
options.UserInteraction.LogoutUrl = "/Account/Logout";</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 18px !important;"><div class="crayon-num" data-line="crayon-5e94bd1aaccee765005617-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5e94bd1aaccee765005617-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 18px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5e94bd1aaccee765005617-1"><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">UserInteraction</span><span class="crayon-sy">.</span><span class="crayon-v">LoginUrl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"/Account/Login"</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e94bd1aaccee765005617-2"><span class="crayon-v">options</span><span class="crayon-sy">.</span><span class="crayon-v">UserInteraction</span><span class="crayon-sy">.</span><span class="crayon-v">LogoutUrl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"/Account/Logout"</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p>&nbsp;</p>
<p style="text-align: justify;">After we scaffolded the ASP.NET Core Identity views and controllers we modified the AccountController and ExternalController for local login and external login to use ASP.NET Core instead of the hardcoded “TestUsers”. We added the service configuration needed for ASP.NET Core Identity in Startup so it will use the SQL server to store the users. In one of the future tutorials, I will show you how to extend the <a href="/final/2019/09/27/05-identityserver4-adding-custom-properties-to-user/">“ApplicationUser”</a> and add custom properties to the user.</p>
<p>If you kept a copy of “wwwroot/css” folder you can now overwrite the files “site.less”, “site.css” and “site.min.css” with your backup copy to get them to the previous version. This will make IdentityServer4 look good (you might notice some weird header issues after scaffolding).</p>
<p>This was a PART 1 of ASP.NET Core Identity tutorial. In <a href="/final/2019/09/24/04-part-2-identityserver4-asp-net-core-identity/">PART 2</a> we will create database migrations, run the migrations to create the database tables and explain each table, similar as we did for the IdentityServer4 but this time for ASP.NET Core Identity.</p>
<p>You can find the project <a href="https://github.com/Deblokt/IdentityServer4Demos/tree/master/04.%20PART%201%20IdentityServer4%20ASP.NET%20Core%20Identity">here</a>.</p>
<h3><strong>Support</strong></h3>
<p style="text-align: justify;">For direct assistance <a href="https://calendly.com/ivan-sedlak/meeting" target="_blank" rel="noopener noreferrer">schedule a technical meeting with Ivan</a> to talk about your requirements.
For a general overview of our services and a live demo <a href="https://calendly.com/maja-stanic/meeting" target="_blank" rel="noopener noreferrer">schedule a meeting with Maja</a>.</p></div>
            <div class="meta-content">
               <div class="tags"></div>
               <div class="navigation pagination">
                  <a class="prev" href="https://deblokt.com/2019/09/23/03-identityserver4-ef-with-postgresql/" rel="prev">Previous</a>                  <a class="next" href="https://deblokt.com/2019/09/24/04-part-2-identityserver4-asp-net-core-identity/" rel="next">Next</a>               </div>
            </div>
         </div>
      </div>
      <div class="page-content comments-content">
         <div id="comments" class="comments-area">
      <div class="reply-title">Comments</div>
      <ul class="comment-list">
      		<li class="comment even thread-even depth-1 parent" id="comment-37">
				<div id="div-comment-37" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src='https://secure.gravatar.com/avatar/d35c8538126dae6f8e66d7667721c7f8?s=70&#038;d=mm&#038;r=g' data-lazy-srcset='https://secure.gravatar.com/avatar/d35c8538126dae6f8e66d7667721c7f8?s=140&#038;d=mm&#038;r=g 2x' class='lazy lazy-hidden avatar avatar-70 photo' height='70' width='70' /><noscript><img alt='' src='https://secure.gravatar.com/avatar/d35c8538126dae6f8e66d7667721c7f8?s=70&#038;d=mm&#038;r=g' srcset='https://secure.gravatar.com/avatar/d35c8538126dae6f8e66d7667721c7f8?s=140&#038;d=mm&#038;r=g 2x' class='avatar avatar-70 photo' height='70' width='70' /></noscript>			<cite class="fn">Søren</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#comment-37">
			December 14, 2019 at 9:43 pm				</a>
						</div>

		<p>The updated templates in .Net Core 3.0 fails when tying to Scaffold Identity:<br />
&#8220;There was en error running the selected code generator:<br />
&#8216;There was an error running the template C:\Users\xxx\.nuget\packages\microsoft.visualstudio.web.codegenerators.mvc\3.0.0\Templates\IdentityVersioned\Bootstrap3\Pages\Account\Account.ConfirmEmailChange.cs.cshtml: Template Processing failed:The explicit expression block is missing a closing &#8220;)&#8221; character. Make sure you have a matching &#8220;)&#8221; character for all the &#8220;(&#8221; characters within this block, and that none of the&#8221;)&#8221; characters are being interpreted as markup.<br />
The explicit expression block is missing a closing &#8220;)&#8221; character. Make sure you have a matching &#8220;)&#8221; character for all the &#8220;(&#8221; characters within this block, and that none of the&#8221;)&#8221; characters are being interpreted as markup.&#8221;</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='#comment-37' data-commentid="37" data-postid="2663" data-belowelement="div-comment-37" data-respondelement="respond" aria-label='Reply to Søren'>Reply</a></div>
				</div>
				<ul class="children">
		<li class="comment byuser comment-author-root bypostauthor odd alt depth-2 parent" id="comment-42">
				<div id="div-comment-42" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=70&#038;d=mm&#038;r=g' data-lazy-srcset='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=140&#038;d=mm&#038;r=g 2x' class='lazy lazy-hidden avatar avatar-70 photo' height='70' width='70' /><noscript><img alt='' src='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=70&#038;d=mm&#038;r=g' srcset='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=140&#038;d=mm&#038;r=g 2x' class='avatar avatar-70 photo' height='70' width='70' /></noscript>			<cite class="fn">deblokt</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#comment-42">
			December 16, 2019 at 4:30 pm				</a>
						</div>

		<p>I would suggest trying .NET Core 3.1 LTS release and update Visual Studio 2019 to the latest version and try again. Scaffolding templates are sometimes broken out of the box 🙁</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='#comment-42' data-commentid="42" data-postid="2663" data-belowelement="div-comment-42" data-respondelement="respond" aria-label='Reply to deblokt'>Reply</a></div>
				</div>
				<ul class="children">
		<li class="comment even depth-3 parent" id="comment-70">
				<div id="div-comment-70" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src='https://secure.gravatar.com/avatar/9caabc2bd3d7ca8a9825510e94268ffd?s=70&#038;d=mm&#038;r=g' data-lazy-srcset='https://secure.gravatar.com/avatar/9caabc2bd3d7ca8a9825510e94268ffd?s=140&#038;d=mm&#038;r=g 2x' class='lazy lazy-hidden avatar avatar-70 photo' height='70' width='70' /><noscript><img alt='' src='https://secure.gravatar.com/avatar/9caabc2bd3d7ca8a9825510e94268ffd?s=70&#038;d=mm&#038;r=g' srcset='https://secure.gravatar.com/avatar/9caabc2bd3d7ca8a9825510e94268ffd?s=140&#038;d=mm&#038;r=g 2x' class='avatar avatar-70 photo' height='70' width='70' /></noscript>			<cite class="fn">Frank</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#comment-70">
			December 23, 2019 at 9:15 pm				</a>
						</div>

		<p>Even with VS 2019 updated to latest version, scaffolding doesn&#8217;t work. Is there any workaround to avoid this error?</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='#comment-70' data-commentid="70" data-postid="2663" data-belowelement="div-comment-70" data-respondelement="respond" aria-label='Reply to Frank'>Reply</a></div>
				</div>
				<ul class="children">
		<li class="comment byuser comment-author-root bypostauthor odd alt depth-4" id="comment-74">
				<div id="div-comment-74" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=70&#038;d=mm&#038;r=g' data-lazy-srcset='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=140&#038;d=mm&#038;r=g 2x' class='lazy lazy-hidden avatar avatar-70 photo' height='70' width='70' /><noscript><img alt='' src='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=70&#038;d=mm&#038;r=g' srcset='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=140&#038;d=mm&#038;r=g 2x' class='avatar avatar-70 photo' height='70' width='70' /></noscript>			<cite class="fn">deblokt</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#comment-74">
			December 24, 2019 at 3:01 pm				</a>
						</div>

		<p>Yes, we just verified there is an issue with the scaffolding template in .NET Core 3.1. A workaround that works at the moment is to uncheck &#8220;Account\ConfirmEmailChange&#8221; razor page when doing scaffolding.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='#comment-74' data-commentid="74" data-postid="2663" data-belowelement="div-comment-74" data-respondelement="respond" aria-label='Reply to deblokt'>Reply</a></div>
				</div>
				</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment even thread-odd thread-alt depth-1 parent" id="comment-85">
				<div id="div-comment-85" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src='https://secure.gravatar.com/avatar/07717fc955d7a4d04526d58815276a46?s=70&#038;d=mm&#038;r=g' data-lazy-srcset='https://secure.gravatar.com/avatar/07717fc955d7a4d04526d58815276a46?s=140&#038;d=mm&#038;r=g 2x' class='lazy lazy-hidden avatar avatar-70 photo' height='70' width='70' /><noscript><img alt='' src='https://secure.gravatar.com/avatar/07717fc955d7a4d04526d58815276a46?s=70&#038;d=mm&#038;r=g' srcset='https://secure.gravatar.com/avatar/07717fc955d7a4d04526d58815276a46?s=140&#038;d=mm&#038;r=g 2x' class='avatar avatar-70 photo' height='70' width='70' /></noscript>			<cite class="fn">Gigante</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#comment-85">
			December 30, 2019 at 1:29 am				</a>
						</div>

		<p>You say to replace the FindUserFromExternalProviderAsync method, but there is no such method, only FindUserFromExternalProvider. I replaced that one, and it seems to work. I&#8217;m using .NET Core 3 if that&#8217;s what causes the confusion?</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='#comment-85' data-commentid="85" data-postid="2663" data-belowelement="div-comment-85" data-respondelement="respond" aria-label='Reply to Gigante'>Reply</a></div>
				</div>
				<ul class="children">
		<li class="comment byuser comment-author-root bypostauthor odd alt depth-2" id="comment-91">
				<div id="div-comment-91" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=70&#038;d=mm&#038;r=g' data-lazy-srcset='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=140&#038;d=mm&#038;r=g 2x' class='lazy lazy-hidden avatar avatar-70 photo' height='70' width='70' /><noscript><img alt='' src='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=70&#038;d=mm&#038;r=g' srcset='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=140&#038;d=mm&#038;r=g 2x' class='avatar avatar-70 photo' height='70' width='70' /></noscript>			<cite class="fn">deblokt</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#comment-91">
			December 30, 2019 at 12:42 pm				</a>
						</div>

		<p>Yes. We are in the process of updating tutorials to .NET Core 3.1.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='#comment-91' data-commentid="91" data-postid="2663" data-belowelement="div-comment-91" data-respondelement="respond" aria-label='Reply to deblokt'>Reply</a></div>
				</div>
				</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 parent" id="comment-357">
				<div id="div-comment-357" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src='https://secure.gravatar.com/avatar/6fefd2d5825da8865d826e020c8c0199?s=70&#038;d=mm&#038;r=g' data-lazy-srcset='https://secure.gravatar.com/avatar/6fefd2d5825da8865d826e020c8c0199?s=140&#038;d=mm&#038;r=g 2x' class='lazy lazy-hidden avatar avatar-70 photo' height='70' width='70' /><noscript><img alt='' src='https://secure.gravatar.com/avatar/6fefd2d5825da8865d826e020c8c0199?s=70&#038;d=mm&#038;r=g' srcset='https://secure.gravatar.com/avatar/6fefd2d5825da8865d826e020c8c0199?s=140&#038;d=mm&#038;r=g 2x' class='avatar avatar-70 photo' height='70' width='70' /></noscript>			<cite class="fn">El'dar</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#comment-357">
			April 11, 2020 at 2:00 pm				</a>
						</div>

		<p>Hm, i have scaffolded identity and complete all eight manuals and i see the cshtml forms are not equal my real interface. So the UI from libraries is still used.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='#comment-357' data-commentid="357" data-postid="2663" data-belowelement="div-comment-357" data-respondelement="respond" aria-label='Reply to El&#039;dar'>Reply</a></div>
				</div>
				<ul class="children">
		<li class="comment byuser comment-author-root bypostauthor odd alt depth-2" id="comment-369">
				<div id="div-comment-369" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-type="image" data-lazy-src='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=70&#038;d=mm&#038;r=g' data-lazy-srcset='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=140&#038;d=mm&#038;r=g 2x' class='lazy lazy-hidden avatar avatar-70 photo' height='70' width='70' /><noscript><img alt='' src='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=70&#038;d=mm&#038;r=g' srcset='https://secure.gravatar.com/avatar/b18e1925f0026150567fc8f655ca187c?s=140&#038;d=mm&#038;r=g 2x' class='avatar avatar-70 photo' height='70' width='70' /></noscript>			<cite class="fn">deblokt</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#comment-369">
			April 13, 2020 at 4:12 pm				</a>
						</div>

		<p>Please compare your code to our example on GitHub (link on top and bottom of each tutorial). Seems like you missed to register something in the pipeline.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='#comment-369' data-commentid="369" data-postid="2663" data-belowelement="div-comment-369" data-respondelement="respond" aria-label='Reply to deblokt'>Reply</a></div>
				</div>
				</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
   </ul>
            	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a comment <small><a rel="nofollow" id="cancel-comment-reply-link" href="/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/#respond" style="display:none;"> - Cancel Reply</a></small></h3><form action="https://deblokt.com/wp-comments-post.php" method="post" id="commentform" class="comment-form"><p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><textarea placeholder="Comment" id="comment" name="comment" cols="45" rows="8" aria-required="true"></textarea></p><p class="comment-form-author"><input placeholder="Name" id="author" name="author" type="text" value="" size="30" /></p>
<p class="comment-form-email"><input placeholder="Email" id="email" name="email" type="text" value="" size="30" /></p>
<p class="comment-form-cookies-consent"><input id="wp-comment-cookies-consent" name="wp-comment-cookies-consent" type="checkbox" value="yes" /> <label for="wp-comment-cookies-consent">Save my name, email, and website in this browser for the next time I comment.</label></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post a Comment" /> <input type='hidden' name='comment_post_ID' value='2663' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p></form>	</div><!-- #respond -->
	 
</div>
      </div>
   </div>
      <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
      <div class="blog_widget"><form role="search" method="get" id="searchform" class="searchform" action="https://deblokt.com/">
				<div>
					<label class="screen-reader-text" for="s">Search for:</label>
					<input type="text" value="" name="s" id="s" />
					<input type="submit" id="searchsubmit" value="Search" />
				</div>
			</form></div><div class="blog_widget"><h5 class="widget-title"><span>Recent Videos</span></h5><ul id="category-posts-3-internal" class="category-posts-internal">
<li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2019/09/01/full-ownership-of-identity-solution-vs-renting-identity-solution/" rel="bookmark">Renting Identity solution vs having Full Ownership of Identity solution</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2019/09/01/authentication-as-a-service-vs-in-app-integrated-authentication-solutions/" rel="bookmark">In-app integrated authentication solutions vs Authentication as a Service</a></div></li></ul>
</div><div class="blog_widget"><h5 class="widget-title"><span>Recent Posts</span></h5><ul id="category-posts-4-internal" class="category-posts-internal">
<li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2020/01/24/08-part-2-identityserver4-mfa-fido2-yubikey-5-net-core-3-1/" rel="bookmark">08. PART 2 IdentityServer4 MFA &#8211; FIDO2 (YubiKey 5) .NET Core 3.1</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2020/01/24/08-part-1-identityserver4-mfa-fido2-yubikey-5-net-core-3-1/" rel="bookmark">08. PART 1 IdentityServer4 MFA &#8211; FIDO2 (YubiKey 5) .NET Core 3.1</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2020/01/24/07-identityserver4-mfa-totp-net-core-3-1/" rel="bookmark">07. IdentityServer4 MFA &#8211; TOTP .NET Core 3.1</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2020/01/24/06-identityserver4-external-providers-net-core-3-1/" rel="bookmark">06. IdentityServer4 External Providers .NET Core 3.1</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2020/01/24/05-identityserver4-adding-custom-properties-to-user-net-core-3-1/" rel="bookmark">05. IdentityServer4 Adding custom properties to User .NET Core 3.1</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2020/01/24/04-part-3-identityserver4-asp-net-core-identity-net-core-3-1/" rel="bookmark">04. PART 3 IdentityServer4 ASP.NET Core Identity .NET Core 3.1</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2020/01/24/04-part-2-identityserver4-asp-net-core-identity-net-core-3-1/" rel="bookmark">04. PART 2 IdentityServer4 ASP.NET Core Identity .NET Core 3.1</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2020/01/24/04-part-1-identityserver4-asp-net-core-identity-net-core-3-1/" rel="bookmark">04. PART 1 IdentityServer4 ASP.NET Core Identity .NET Core 3.1</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2020/01/24/03-identityserver4-ef-with-postgresql-net-core-3-1/" rel="bookmark">03. IdentityServer4 EF With PostgreSQL .NET Core 3.1</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2020/01/24/02-identityserver4-entityframework-net-core-3-1/" rel="bookmark">02. IdentityServer4 EntityFramework .NET Core 3.1</a></div></li></ul>
</div><div class="blog_widget"><h5 class="widget-title"><span>Older Posts</span></h5><ul id="category-posts-2-internal" class="category-posts-internal">
<li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2019/12/11/08-part-2-identityserver4-mfa-fido2-yubikey-5/" rel="bookmark">08. PART 2 IdentityServer4 MFA &#8211; FIDO2 (YubiKey 5)</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2019/10/21/08-identityserver4-mfa-fido2-yubikey-5/" rel="bookmark">08. PART 1 IdentityServer4 MFA &#8211; FIDO2 (YubiKey 5)</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2019/10/09/07-identityserver4-mfa-totp/" rel="bookmark">07. IdentityServer4 MFA &#8211; TOTP</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2019/09/30/06-identityserver4-external-providers/" rel="bookmark">06. IdentityServer4 External Providers</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2019/09/27/05-identityserver4-adding-custom-properties-to-user/" rel="bookmark">05. IdentityServer4 Adding custom properties to User</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2019/09/26/04-part-3-identityserver4-asp-net-core-identity/" rel="bookmark">04. PART 3 IdentityServer4 ASP.NET Core Identity</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2019/09/24/04-part-2-identityserver4-asp-net-core-identity/" rel="bookmark">04. PART 2 IdentityServer4 ASP.NET Core Identity</a></div></li><li class='cat-post-item cat-post-current'><div><a class="cat-post-title" href="https://deblokt.com/2019/09/23/04-part-1-identityserver4-asp-net-core-identity/" rel="bookmark">04. PART 1 IdentityServer4 ASP.NET Core Identity</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2019/09/23/03-identityserver4-ef-with-postgresql/" rel="bookmark">03. IdentityServer4 EF With PostgreSQL</a></div></li><li class='cat-post-item'><div><a class="cat-post-title" href="https://deblokt.com/2019/09/20/02-identityserver4-entityframework/" rel="bookmark">02. IdentityServer4 EntityFramework</a></div></li></ul>
</div>   </div>
         </div>
</div>
<footer id="footer">
   <div class="container">
      <div class="lower-footer">
         <div class="pull-left">
            <span>© 2019 Deblokt LLC – Removing roadblocks in your business</span>
         </div>
         <div id="social-icons" class="pull-right">
            <a href="http://facebook.com/deblokt" target="_blank"><span class="fa fa-facebook"></span></a>            <a href="http://twitter.com/deblokt" target="_blank"><span class="fa fa-twitter"></span></a>                        <a href="https://www.instagram.com/deblokt/" target="_blank"><span class="fa fa-instagram"></span></a>                        <a href="https://www.linkedin.com/company/deblokt-doo-subotica/" target="_blank"><span class="fa fa-linkedin"></span></a>         </div>
      </div>
   </div>
</footer>
<script type="text/javascript">
_linkedin_partner_id = "1590833";
window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
window._linkedin_data_partner_ids.push(_linkedin_partner_id);
</script><script type="text/javascript">
(function(){var s = document.getElementsByTagName("script")[0];
var b = document.createElement("script");
b.type = "text/javascript";b.async = true;
b.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
s.parentNode.insertBefore(b, s);})();
</script>
<noscript>
<img height="1" width="1" style="display:none;" alt="" src="https://px.ads.linkedin.com/collect/?pid=1590833&fmt=gif(43 B)
https://px.ads.linkedin.com/collect/?pid=1590833&fmt=gif
" />
</noscript>



<script type='text/javascript'>
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"https:\/\/deblokt.com\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"cached":"1"};
/* ]]> */
</script>



<script type='text/javascript' src='https://maps.googleapis.com/maps/api/js?key=AIzaSyB-Tmwj8eKrZ-Kkc7kSotp67bFwwKOpQwE'></script>








        <script type="text/javascript">
            var envira_galleries = [],envira_gallery_images = [],envira_isotopes = [],envira_isotopes_config = [];jQuery(document).ready(function($){var envira_container_2670 = '';function envira_album_lazy_load_image( $id ) {}$('#envira-gallery-2670').enviraJustifiedGallery({rowHeight : 500,maxRowHeight: -1,waitThumbnailsLoad: true,selector: '> div > div',lastRow: 'nojustify',border: 0,margins: 1,});$('#envira-gallery-2670').justifiedGallery().on('jg.complete', function (e) {envira_album_lazy_load_image(2670);$(window).scroll(function(event){envira_album_lazy_load_image(2670);});});$( document ).on( "envira_pagination_ajax_load_completed", function() {$('#envira-gallery-2670').justifiedGallery().on('jg.complete', function (e) {envira_album_lazy_load_image(2670);$(window).scroll(function(event){envira_album_lazy_load_image(2670);});});});$('#envira-gallery-2670').css('opacity', '1');envira_container_2670 = $('#envira-gallery-2670').enviraImagesLoaded( function() {$('.envira-gallery-item img').fadeTo( 'slow', 1 );});envira_gallery_options = {padding: 15,cyclic: true,titlePosition: 'float',margin: 60,arrows: 1,aspectRatio: 1,loop: 1,mouseWheel: 1,preload: 1,openEffect: 'fade',closeEffect: 'fade',nextEffect: 'fade',prevEffect: 'fade',tpl: {wrap : '<div class="envirabox-wrap" tabIndex="-1"><div class="envirabox-skin envirabox-theme-base"><div class="envirabox-outer"><div class="envirabox-inner"><div class="envirabox-position-overlay envira-gallery-top-left"></div><div class="envirabox-position-overlay envira-gallery-top-right"></div><div class="envirabox-position-overlay envira-gallery-bottom-left"></div><div class="envirabox-position-overlay envira-gallery-bottom-right"></div></div></div></div></div>',image: '<img class="envirabox-image" src="{href}" alt="" data-envira-title="" data-envira-caption="" data-envira-index="" data-envira-data="" />',iframe : '<iframe id="envirabox-frame{rnd}" name="envirabox-frame{rnd}" class="envirabox-iframe" frameborder="0" vspace="0" hspace="0" allowtransparency="true" wekitallowfullscreen mozallowfullscreen allowfullscreen></iframe>',error: '<p class="envirabox-error">The requested content cannot be loaded.<br/>Please try again later.</p>',closeBtn : '<a title="Close" class="envirabox-item envirabox-close" href="#"></a>',next : '<a title="Next" class="envirabox-nav envirabox-next envirabox-arrows-inside" href="#"><span></span></a>',prev : '<a title="Previous" class="envirabox-nav envirabox-prev envirabox-arrows-inside" href="#"><span></span></a>'},helpers: {title: {type: 'float'},},beforeLoad: function(){this.title = $(this.element).attr('data-envira-caption');},afterLoad: function(){$('envirabox-overlay-fixed').on({'touchmove' : function(e){e.preventDefault();}});},beforeShow: function(){$(window).on({'resize.envirabox' : function(){$.envirabox.update();}});if ( typeof this.element === 'undefined' ) {var gallery_id = this.group[ this.index ].gallery_id;var gallery_item_id = this.group[ this.index ].id;var alt = this.group[ this.index ].alt;var title = this.group[ this.index ].title;var caption = this.group[ this.index ].caption;var index = this.index;} else {var gallery_id = this.element.find('img').data('envira-gallery-id');var gallery_item_id = this.element.find('img').data('envira-item-id');var alt = this.element.find('img').attr('alt');var title = this.element.find('img').parent().attr('title');var caption = this.element.find('img').parent().data('envira-caption');var retina_image = this.element.find('img').parent().data('envira-retina');var index = this.element.find('img').data('envira-index');}this.inner.find('img').attr('alt', alt).attr('data-envira-gallery-id', gallery_id).attr('data-envira-item-id', gallery_item_id).attr('data-envira-title', title).attr('data-envira-caption', caption).attr('data-envira-index', index);if ( typeof retina_image !== 'undefined' && retina_image !== '' ) {this.inner.find('img').attr('srcset', retina_image + ' 2x');}},onStart: function(){$('#envirabox-wrap, #envirabox-wrap #envirabox-left, #envirabox-wrap #envirabox-right').swipe( {excludedElements:"label, button, input, select, textarea, .noSwipe",swipe: function(event, direction, distance, duration, fingerCount, fingerData) {if (direction === 'left') {$.envirabox.next(direction);} else if (direction === 'right') {$.envirabox.prev(direction);} else if (direction === 'up') {$.envirabox.close();}}} );},beforeClose: function(){},afterClose: function(){$(window).off('resize.envirabox');},onUpdate: function(){},onCancel: function(){},onPlayStart: function(){},onPlayEnd: function(){}};envira_galleries['2670'] = $('.envira-gallery-2670').envirabox( envira_gallery_options );var envira_container_2674 = '';function envira_album_lazy_load_image( $id ) {}$('#envira-gallery-2674').enviraJustifiedGallery({rowHeight : 700,maxRowHeight: -1,waitThumbnailsLoad: true,selector: '> div > div',lastRow: 'nojustify',border: 0,margins: 1,});$('#envira-gallery-2674').justifiedGallery().on('jg.complete', function (e) {envira_album_lazy_load_image(2674);$(window).scroll(function(event){envira_album_lazy_load_image(2674);});});$( document ).on( "envira_pagination_ajax_load_completed", function() {$('#envira-gallery-2674').justifiedGallery().on('jg.complete', function (e) {envira_album_lazy_load_image(2674);$(window).scroll(function(event){envira_album_lazy_load_image(2674);});});});$('#envira-gallery-2674').css('opacity', '1');envira_container_2674 = $('#envira-gallery-2674').enviraImagesLoaded( function() {$('.envira-gallery-item img').fadeTo( 'slow', 1 );});envira_gallery_options = {padding: 15,cyclic: true,titlePosition: 'float',margin: 60,arrows: 1,aspectRatio: 1,loop: 1,mouseWheel: 1,preload: 1,openEffect: 'fade',closeEffect: 'fade',nextEffect: 'fade',prevEffect: 'fade',tpl: {wrap : '<div class="envirabox-wrap" tabIndex="-1"><div class="envirabox-skin envirabox-theme-base"><div class="envirabox-outer"><div class="envirabox-inner"><div class="envirabox-position-overlay envira-gallery-top-left"></div><div class="envirabox-position-overlay envira-gallery-top-right"></div><div class="envirabox-position-overlay envira-gallery-bottom-left"></div><div class="envirabox-position-overlay envira-gallery-bottom-right"></div></div></div></div></div>',image: '<img class="envirabox-image" src="{href}" alt="" data-envira-title="" data-envira-caption="" data-envira-index="" data-envira-data="" />',iframe : '<iframe id="envirabox-frame{rnd}" name="envirabox-frame{rnd}" class="envirabox-iframe" frameborder="0" vspace="0" hspace="0" allowtransparency="true" wekitallowfullscreen mozallowfullscreen allowfullscreen></iframe>',error: '<p class="envirabox-error">The requested content cannot be loaded.<br/>Please try again later.</p>',closeBtn : '<a title="Close" class="envirabox-item envirabox-close" href="#"></a>',next : '<a title="Next" class="envirabox-nav envirabox-next envirabox-arrows-inside" href="#"><span></span></a>',prev : '<a title="Previous" class="envirabox-nav envirabox-prev envirabox-arrows-inside" href="#"><span></span></a>'},helpers: {title: {type: 'float'},},beforeLoad: function(){this.title = $(this.element).attr('data-envira-caption');},afterLoad: function(){$('envirabox-overlay-fixed').on({'touchmove' : function(e){e.preventDefault();}});},beforeShow: function(){$(window).on({'resize.envirabox' : function(){$.envirabox.update();}});if ( typeof this.element === 'undefined' ) {var gallery_id = this.group[ this.index ].gallery_id;var gallery_item_id = this.group[ this.index ].id;var alt = this.group[ this.index ].alt;var title = this.group[ this.index ].title;var caption = this.group[ this.index ].caption;var index = this.index;} else {var gallery_id = this.element.find('img').data('envira-gallery-id');var gallery_item_id = this.element.find('img').data('envira-item-id');var alt = this.element.find('img').attr('alt');var title = this.element.find('img').parent().attr('title');var caption = this.element.find('img').parent().data('envira-caption');var retina_image = this.element.find('img').parent().data('envira-retina');var index = this.element.find('img').data('envira-index');}this.inner.find('img').attr('alt', alt).attr('data-envira-gallery-id', gallery_id).attr('data-envira-item-id', gallery_item_id).attr('data-envira-title', title).attr('data-envira-caption', caption).attr('data-envira-index', index);if ( typeof retina_image !== 'undefined' && retina_image !== '' ) {this.inner.find('img').attr('srcset', retina_image + ' 2x');}},onStart: function(){$('#envirabox-wrap, #envirabox-wrap #envirabox-left, #envirabox-wrap #envirabox-right').swipe( {excludedElements:"label, button, input, select, textarea, .noSwipe",swipe: function(event, direction, distance, duration, fingerCount, fingerData) {if (direction === 'left') {$.envirabox.next(direction);} else if (direction === 'right') {$.envirabox.prev(direction);} else if (direction === 'up') {$.envirabox.close();}}} );},beforeClose: function(){},afterClose: function(){$(window).off('resize.envirabox');},onUpdate: function(){},onCancel: function(){},onPlayStart: function(){},onPlayEnd: function(){}};envira_galleries['2674'] = $('.envira-gallery-2674').envirabox( envira_gallery_options );var envira_container_2677 = '';function envira_album_lazy_load_image( $id ) {}$('#envira-gallery-2677').enviraJustifiedGallery({rowHeight : 600,maxRowHeight: -1,waitThumbnailsLoad: true,selector: '> div > div',lastRow: 'nojustify',border: 0,margins: 1,});$('#envira-gallery-2677').justifiedGallery().on('jg.complete', function (e) {envira_album_lazy_load_image(2677);$(window).scroll(function(event){envira_album_lazy_load_image(2677);});});$( document ).on( "envira_pagination_ajax_load_completed", function() {$('#envira-gallery-2677').justifiedGallery().on('jg.complete', function (e) {envira_album_lazy_load_image(2677);$(window).scroll(function(event){envira_album_lazy_load_image(2677);});});});$('#envira-gallery-2677').css('opacity', '1');envira_container_2677 = $('#envira-gallery-2677').enviraImagesLoaded( function() {$('.envira-gallery-item img').fadeTo( 'slow', 1 );});envira_gallery_options = {padding: 15,cyclic: true,titlePosition: 'float',margin: 60,arrows: 1,aspectRatio: 1,loop: 1,mouseWheel: 1,preload: 1,openEffect: 'fade',closeEffect: 'fade',nextEffect: 'fade',prevEffect: 'fade',tpl: {wrap : '<div class="envirabox-wrap" tabIndex="-1"><div class="envirabox-skin envirabox-theme-base"><div class="envirabox-outer"><div class="envirabox-inner"><div class="envirabox-position-overlay envira-gallery-top-left"></div><div class="envirabox-position-overlay envira-gallery-top-right"></div><div class="envirabox-position-overlay envira-gallery-bottom-left"></div><div class="envirabox-position-overlay envira-gallery-bottom-right"></div></div></div></div></div>',image: '<img class="envirabox-image" src="{href}" alt="" data-envira-title="" data-envira-caption="" data-envira-index="" data-envira-data="" />',iframe : '<iframe id="envirabox-frame{rnd}" name="envirabox-frame{rnd}" class="envirabox-iframe" frameborder="0" vspace="0" hspace="0" allowtransparency="true" wekitallowfullscreen mozallowfullscreen allowfullscreen></iframe>',error: '<p class="envirabox-error">The requested content cannot be loaded.<br/>Please try again later.</p>',closeBtn : '<a title="Close" class="envirabox-item envirabox-close" href="#"></a>',next : '<a title="Next" class="envirabox-nav envirabox-next envirabox-arrows-inside" href="#"><span></span></a>',prev : '<a title="Previous" class="envirabox-nav envirabox-prev envirabox-arrows-inside" href="#"><span></span></a>'},helpers: {title: {type: 'float'},},beforeLoad: function(){this.title = $(this.element).attr('data-envira-caption');},afterLoad: function(){$('envirabox-overlay-fixed').on({'touchmove' : function(e){e.preventDefault();}});},beforeShow: function(){$(window).on({'resize.envirabox' : function(){$.envirabox.update();}});if ( typeof this.element === 'undefined' ) {var gallery_id = this.group[ this.index ].gallery_id;var gallery_item_id = this.group[ this.index ].id;var alt = this.group[ this.index ].alt;var title = this.group[ this.index ].title;var caption = this.group[ this.index ].caption;var index = this.index;} else {var gallery_id = this.element.find('img').data('envira-gallery-id');var gallery_item_id = this.element.find('img').data('envira-item-id');var alt = this.element.find('img').attr('alt');var title = this.element.find('img').parent().attr('title');var caption = this.element.find('img').parent().data('envira-caption');var retina_image = this.element.find('img').parent().data('envira-retina');var index = this.element.find('img').data('envira-index');}this.inner.find('img').attr('alt', alt).attr('data-envira-gallery-id', gallery_id).attr('data-envira-item-id', gallery_item_id).attr('data-envira-title', title).attr('data-envira-caption', caption).attr('data-envira-index', index);if ( typeof retina_image !== 'undefined' && retina_image !== '' ) {this.inner.find('img').attr('srcset', retina_image + ' 2x');}},onStart: function(){$('#envirabox-wrap, #envirabox-wrap #envirabox-left, #envirabox-wrap #envirabox-right').swipe( {excludedElements:"label, button, input, select, textarea, .noSwipe",swipe: function(event, direction, distance, duration, fingerCount, fingerData) {if (direction === 'left') {$.envirabox.next(direction);} else if (direction === 'right') {$.envirabox.prev(direction);} else if (direction === 'up') {$.envirabox.close();}}} );},beforeClose: function(){},afterClose: function(){$(window).off('resize.envirabox');},onUpdate: function(){},onCancel: function(){},onPlayStart: function(){},onPlayEnd: function(){}};envira_galleries['2677'] = $('.envira-gallery-2677').envirabox( envira_gallery_options );var envira_container_2680 = '';function envira_album_lazy_load_image( $id ) {}$('#envira-gallery-2680').enviraJustifiedGallery({rowHeight : 500,maxRowHeight: -1,waitThumbnailsLoad: true,selector: '> div > div',lastRow: 'nojustify',border: 0,margins: 1,});$('#envira-gallery-2680').justifiedGallery().on('jg.complete', function (e) {envira_album_lazy_load_image(2680);$(window).scroll(function(event){envira_album_lazy_load_image(2680);});});$( document ).on( "envira_pagination_ajax_load_completed", function() {$('#envira-gallery-2680').justifiedGallery().on('jg.complete', function (e) {envira_album_lazy_load_image(2680);$(window).scroll(function(event){envira_album_lazy_load_image(2680);});});});$('#envira-gallery-2680').css('opacity', '1');envira_container_2680 = $('#envira-gallery-2680').enviraImagesLoaded( function() {$('.envira-gallery-item img').fadeTo( 'slow', 1 );});envira_gallery_options = {padding: 15,cyclic: true,titlePosition: 'float',margin: 60,arrows: 1,aspectRatio: 1,loop: 1,mouseWheel: 1,preload: 1,openEffect: 'fade',closeEffect: 'fade',nextEffect: 'fade',prevEffect: 'fade',tpl: {wrap : '<div class="envirabox-wrap" tabIndex="-1"><div class="envirabox-skin envirabox-theme-base"><div class="envirabox-outer"><div class="envirabox-inner"><div class="envirabox-position-overlay envira-gallery-top-left"></div><div class="envirabox-position-overlay envira-gallery-top-right"></div><div class="envirabox-position-overlay envira-gallery-bottom-left"></div><div class="envirabox-position-overlay envira-gallery-bottom-right"></div></div></div></div></div>',image: '<img class="envirabox-image" src="{href}" alt="" data-envira-title="" data-envira-caption="" data-envira-index="" data-envira-data="" />',iframe : '<iframe id="envirabox-frame{rnd}" name="envirabox-frame{rnd}" class="envirabox-iframe" frameborder="0" vspace="0" hspace="0" allowtransparency="true" wekitallowfullscreen mozallowfullscreen allowfullscreen></iframe>',error: '<p class="envirabox-error">The requested content cannot be loaded.<br/>Please try again later.</p>',closeBtn : '<a title="Close" class="envirabox-item envirabox-close" href="#"></a>',next : '<a title="Next" class="envirabox-nav envirabox-next envirabox-arrows-inside" href="#"><span></span></a>',prev : '<a title="Previous" class="envirabox-nav envirabox-prev envirabox-arrows-inside" href="#"><span></span></a>'},helpers: {title: {type: 'float'},},beforeLoad: function(){this.title = $(this.element).attr('data-envira-caption');},afterLoad: function(){$('envirabox-overlay-fixed').on({'touchmove' : function(e){e.preventDefault();}});},beforeShow: function(){$(window).on({'resize.envirabox' : function(){$.envirabox.update();}});if ( typeof this.element === 'undefined' ) {var gallery_id = this.group[ this.index ].gallery_id;var gallery_item_id = this.group[ this.index ].id;var alt = this.group[ this.index ].alt;var title = this.group[ this.index ].title;var caption = this.group[ this.index ].caption;var index = this.index;} else {var gallery_id = this.element.find('img').data('envira-gallery-id');var gallery_item_id = this.element.find('img').data('envira-item-id');var alt = this.element.find('img').attr('alt');var title = this.element.find('img').parent().attr('title');var caption = this.element.find('img').parent().data('envira-caption');var retina_image = this.element.find('img').parent().data('envira-retina');var index = this.element.find('img').data('envira-index');}this.inner.find('img').attr('alt', alt).attr('data-envira-gallery-id', gallery_id).attr('data-envira-item-id', gallery_item_id).attr('data-envira-title', title).attr('data-envira-caption', caption).attr('data-envira-index', index);if ( typeof retina_image !== 'undefined' && retina_image !== '' ) {this.inner.find('img').attr('srcset', retina_image + ' 2x');}},onStart: function(){$('#envirabox-wrap, #envirabox-wrap #envirabox-left, #envirabox-wrap #envirabox-right').swipe( {excludedElements:"label, button, input, select, textarea, .noSwipe",swipe: function(event, direction, distance, duration, fingerCount, fingerData) {if (direction === 'left') {$.envirabox.next(direction);} else if (direction === 'right') {$.envirabox.prev(direction);} else if (direction === 'up') {$.envirabox.close();}}} );},beforeClose: function(){},afterClose: function(){$(window).off('resize.envirabox');},onUpdate: function(){},onCancel: function(){},onPlayStart: function(){},onPlayEnd: function(){}};envira_galleries['2680'] = $('.envira-gallery-2680').envirabox( envira_gallery_options );var envira_container_2683 = '';function envira_album_lazy_load_image( $id ) {}$('#envira-gallery-2683').enviraJustifiedGallery({rowHeight : 900,maxRowHeight: -1,waitThumbnailsLoad: true,selector: '> div > div',lastRow: 'nojustify',border: 0,margins: 1,});$('#envira-gallery-2683').justifiedGallery().on('jg.complete', function (e) {envira_album_lazy_load_image(2683);$(window).scroll(function(event){envira_album_lazy_load_image(2683);});});$( document ).on( "envira_pagination_ajax_load_completed", function() {$('#envira-gallery-2683').justifiedGallery().on('jg.complete', function (e) {envira_album_lazy_load_image(2683);$(window).scroll(function(event){envira_album_lazy_load_image(2683);});});});$('#envira-gallery-2683').css('opacity', '1');envira_container_2683 = $('#envira-gallery-2683').enviraImagesLoaded( function() {$('.envira-gallery-item img').fadeTo( 'slow', 1 );});envira_gallery_options = {padding: 15,cyclic: true,titlePosition: 'float',margin: 60,arrows: 1,aspectRatio: 1,loop: 1,mouseWheel: 1,preload: 1,openEffect: 'fade',closeEffect: 'fade',nextEffect: 'fade',prevEffect: 'fade',tpl: {wrap : '<div class="envirabox-wrap" tabIndex="-1"><div class="envirabox-skin envirabox-theme-base"><div class="envirabox-outer"><div class="envirabox-inner"><div class="envirabox-position-overlay envira-gallery-top-left"></div><div class="envirabox-position-overlay envira-gallery-top-right"></div><div class="envirabox-position-overlay envira-gallery-bottom-left"></div><div class="envirabox-position-overlay envira-gallery-bottom-right"></div></div></div></div></div>',image: '<img class="envirabox-image" src="{href}" alt="" data-envira-title="" data-envira-caption="" data-envira-index="" data-envira-data="" />',iframe : '<iframe id="envirabox-frame{rnd}" name="envirabox-frame{rnd}" class="envirabox-iframe" frameborder="0" vspace="0" hspace="0" allowtransparency="true" wekitallowfullscreen mozallowfullscreen allowfullscreen></iframe>',error: '<p class="envirabox-error">The requested content cannot be loaded.<br/>Please try again later.</p>',closeBtn : '<a title="Close" class="envirabox-item envirabox-close" href="#"></a>',next : '<a title="Next" class="envirabox-nav envirabox-next envirabox-arrows-inside" href="#"><span></span></a>',prev : '<a title="Previous" class="envirabox-nav envirabox-prev envirabox-arrows-inside" href="#"><span></span></a>'},helpers: {title: {type: 'float'},},beforeLoad: function(){this.title = $(this.element).attr('data-envira-caption');},afterLoad: function(){$('envirabox-overlay-fixed').on({'touchmove' : function(e){e.preventDefault();}});},beforeShow: function(){$(window).on({'resize.envirabox' : function(){$.envirabox.update();}});if ( typeof this.element === 'undefined' ) {var gallery_id = this.group[ this.index ].gallery_id;var gallery_item_id = this.group[ this.index ].id;var alt = this.group[ this.index ].alt;var title = this.group[ this.index ].title;var caption = this.group[ this.index ].caption;var index = this.index;} else {var gallery_id = this.element.find('img').data('envira-gallery-id');var gallery_item_id = this.element.find('img').data('envira-item-id');var alt = this.element.find('img').attr('alt');var title = this.element.find('img').parent().attr('title');var caption = this.element.find('img').parent().data('envira-caption');var retina_image = this.element.find('img').parent().data('envira-retina');var index = this.element.find('img').data('envira-index');}this.inner.find('img').attr('alt', alt).attr('data-envira-gallery-id', gallery_id).attr('data-envira-item-id', gallery_item_id).attr('data-envira-title', title).attr('data-envira-caption', caption).attr('data-envira-index', index);if ( typeof retina_image !== 'undefined' && retina_image !== '' ) {this.inner.find('img').attr('srcset', retina_image + ' 2x');}},onStart: function(){$('#envirabox-wrap, #envirabox-wrap #envirabox-left, #envirabox-wrap #envirabox-right').swipe( {excludedElements:"label, button, input, select, textarea, .noSwipe",swipe: function(event, direction, distance, duration, fingerCount, fingerData) {if (direction === 'left') {$.envirabox.next(direction);} else if (direction === 'right') {$.envirabox.prev(direction);} else if (direction === 'up') {$.envirabox.close();}}} );},beforeClose: function(){},afterClose: function(){$(window).off('resize.envirabox');},onUpdate: function(){},onCancel: function(){},onPlayStart: function(){},onPlayEnd: function(){}};envira_galleries['2683'] = $('.envira-gallery-2683').envirabox( envira_gallery_options );});        </script>
        <script defer src="https://deblokt.com/wp-content/cache/autoptimize/js/autoptimize_87ce642cf3e50fe5ce53d196510abd2c.js"></script></body>
</html>
<!--
Performance optimized by W3 Total Cache. Learn more: https://www.boldgrid.com/w3-total-cache/

Page Caching using disk: enhanced 

Served from: deblokt.com @ 2020-04-13 21:27:27 by W3 Total Cache
-->